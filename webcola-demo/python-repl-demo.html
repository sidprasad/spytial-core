<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python REPL Demo with CnD-Core</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêç Python REPL Demo with CnD Graph</h1>
        <p>This demo shows the Python REPL Interface with CnD graph visualization capabilities.</p>
        
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107;">
            <h3 style="margin-top: 0;">Python Data Instance Features</h3>
            <p>This demo showcases Python-specific functionality for creating and manipulating data instances with familiar Python syntax.</p>
            
            <h4>Try these commands in the REPL:</h4>
            <ul>
                <li><code>x = 1</code> - Basic variable assignment</li>
                <li><code>alice = "Alice"</code> - String assignment</li>
                <li><code>alice:Person</code> - Type annotation</li>
                <li><code>numbers = [1, 2, 3]</code> - List creation (with external evaluator)</li>
            </ul>
            
            <p><strong>Note:</strong> For full Python object support, this demo can optionally use Pyodide or other web Python runtimes.</p>
        </div>
        
        <button onclick="setupBasicPythonDemo()">Start Basic Python REPL</button>
        <button onclick="setupEnhancedPythonDemo()">Start Enhanced Python REPL (with Pyodide)</button>
        <button onclick="clearPythonDemo()">Clear Demo</button>
        
        <div id="python-repl-demo-container" style="height: 800px; border: 1px solid #ddd; border-radius: 8px; margin: 15px 0;">
            <div style="padding: 40px; text-align: center; color: #666;">
                <h3>Python REPL Interface with CnD Graph</h3>
                <p>Click "Start Basic Python REPL" or "Start Enhanced Python REPL" to begin</p>
            </div>
        </div>
        
        <div style="background-color: #e8f5e8; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #28a745;">
            <h3 style="margin-top: 0;">Python Commands Overview</h3>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; white-space: pre-line;">
<strong>Basic assignments:</strong>
x = 1
alice = "Alice"  
is_active = True

<strong>Type annotations:</strong>
alice:Person

<strong>With external evaluator (Pyodide):</strong>
my_list = [1, 2, 3]
class Person:
    def __init__(self, name):
        self.name = name

alice = Person("Alice")

<strong>Utility commands:</strong>
info        # Show current instance status
reify       # Generate Python constructor notation
clear       # Clear the instance
help        # Show available commands
            </div>
        </div>
    </div>

    <!-- CnD Core Library (browser build) -->
    <script src="../dist/browser/cnd-core-complete.global.js"></script>
    <link rel="stylesheet" href="../dist/browser/cnd-core-complete.css">

    <script>
        /**
         * Set up basic Python REPL demo (no external evaluator)
         */
        function setupBasicPythonDemo() {
            console.log('üöÄ Setting up basic Python REPL demo with CnD graph...');
            
            // Clear existing content
            clearPythonDemo();
            
            if (!window.CndCore) {
                console.error('‚ùå CnD-Core not loaded');
                showError('CnD-Core library not loaded. Please ensure the built library files are available.');
                return;
            }

            try {
                setupCombinedPythonDemo(null);
                
            } catch (error) {
                console.error('‚ùå Failed to setup basic Python REPL:', error);
                showError(`Failed to setup basic Python REPL: ${error.message}`);
            }
        }

        /**
         * Set up enhanced Python REPL demo (with Pyodide)
         */
        async function setupEnhancedPythonDemo() {
            console.log('üöÄ Setting up enhanced Python REPL demo with Pyodide and CnD graph...');
            
            // Clear existing content
            clearPythonDemo();
            
            if (!window.CndCore) {
                console.error('‚ùå CnD-Core not loaded');
                showError('CnD-Core library not loaded. Please ensure the built library files are available.');
                return;
            }

            try {
                const container = document.getElementById('python-repl-demo-container');
                
                // Show loading message
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <h3>üîÑ Loading Pyodide...</h3>
                        <p>This may take a moment on first load</p>
                    </div>
                `;
                
                // Load Pyodide
                const pyodideEvaluator = await loadPyodideEvaluator();
                
                setupCombinedPythonDemo(pyodideEvaluator);
                
            } catch (error) {
                console.error('‚ùå Failed to setup enhanced Python REPL:', error);
                showError(`Failed to setup enhanced Python REPL: ${error.message}`);
            }
        }

        /**
         * Set up combined Python REPL with CnD graph visualization
         */
        function setupCombinedPythonDemo(externalEvaluator) {
            const container = document.getElementById('python-repl-demo-container');
            
            // Create a simpler layout similar to the Pyret demo but for Python
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%; background: white;">
                    <!-- Top section with REPL -->
                    <div style="border-bottom: 1px solid #ddd; flex-shrink: 0;">
                        <div style="padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleSection('python-repl-section')">
                            <span style="font-size: 12px;">‚ñº</span>
                            <span style="font-weight: bold;">Python REPL</span>
                            <span style="color: #666; font-size: 12px;" id="python-atom-count">‚Ä¢ ‚Ä¢</span>
                        </div>
                        <div id="python-repl-section" style="padding: 10px;">
                            <div id="python-repl-container" style="height: 120px;"></div>
                        </div>
                    </div>
                    
                    <!-- Middle section with Graph -->
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <div style="padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleSection('python-graph-section')">
                            <span style="font-size: 12px;">‚ñº</span>
                            <span style="font-weight: bold;">CnD Graph</span>
                            <span style="color: #666; font-size: 12px;" id="python-graph-status">Ready</span>
                        </div>
                        <div id="python-graph-section" style="flex: 1; min-height: 0; position: relative; padding: 10px;">
                            <!-- Simple graph placeholder that shows atoms and relations -->
                            <div id="simple-graph-container" style="width: 100%; height: 100%; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                <div style="text-align: center; color: #666;">
                                    <h4 style="margin: 10px 0;">üìä Data Visualization</h4>
                                    <div id="graph-content">
                                        <p>No data to visualize yet</p>
                                        <p>Add some data using the Python REPL above</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create Python data instance
            const pythonInstance = new window.CndCore.PythonDataInstance();
            
            // Mount the Python REPL in the inner container
            const replSuccess = window.CndCore.mountPythonRepl({
                containerId: 'python-repl-container',
                height: '120px',
                width: '100%',
                externalEvaluator: externalEvaluator,
                initialInstance: pythonInstance,
                onChange: (instance) => {
                    console.log('üîÑ Python data updated:', {
                        atoms: instance.getAtoms().length,
                        relations: instance.getRelations().length
                    });
                    
                    console.log('üîç Calling updateAtomCount...');
                    // Update atom/relation count display
                    updateAtomCount(instance);
                    
                    console.log('üîç Calling updateSimpleGraph...');
                    // Update the simple graph display
                    updateSimpleGraph(instance);
                    
                    console.log('‚úÖ Update callbacks completed');
                },
                onCndSpecExtracted: (spec) => {
                    console.log('üìê CnD spec extracted:', spec);
                }
            });
            
            if (replSuccess) {
                console.log('‚úÖ Python REPL mounted successfully');
                
                // Initialize the displays
                updateAtomCount(pythonInstance);
                updateSimpleGraph(pythonInstance);
                
                // Update status
                document.getElementById('python-graph-status').textContent = 'Initialized';
                
                console.log('‚úÖ Combined Python demo ready!');
                
                // Add a test button to manually check the data instance
                const debugButton = document.createElement('button');
                debugButton.textContent = 'Debug: Check Data';
                debugButton.style.margin = '5px';
                debugButton.onclick = () => {
                    console.log('üîç Manual debug check...');
                    console.log('Current instance:', pythonInstance);
                    console.log('Atoms:', pythonInstance.getAtoms());
                    console.log('Relations:', pythonInstance.getRelations());
                    
                    // Manually call update functions
                    updateAtomCount(pythonInstance);
                    updateSimpleGraph(pythonInstance);
                };
                
                document.getElementById('python-graph-section').appendChild(debugButton);
                
            } else {
                showError('Failed to mount Python REPL component');
            }
        }

        /**
         * Update the atom/relation count display
         */
        function updateAtomCount(instance) {
            console.log('üìä updateAtomCount called', instance);
            const countElement = document.getElementById('python-atom-count');
            if (countElement && instance) {
                const atomCount = instance.getAtoms().length;
                const relationCount = instance.getRelations().length;
                countElement.textContent = `${atomCount} ‚Ä¢ ${relationCount}`;
                console.log('üìä Atom count updated:', countElement.textContent);
            } else {
                console.log('‚ùå Count element or instance not found');
            }
        }
        
        /**
         * Update the simple graph display with Python data
         */
        function updateSimpleGraph(instance) {
            console.log('üéØ updateSimpleGraph called', instance);
            const graphContent = document.getElementById('graph-content');
            if (!graphContent || !instance) {
                console.log('‚ùå Graph content element or instance not found');
                return;
            }
            
            try {
                const atoms = instance.getAtoms();
                const relations = instance.getRelations();
                
                console.log('üîç Data found:', { atomCount: atoms.length, relationCount: relations.length });
                
                if (atoms.length === 0) {
                    graphContent.innerHTML = `
                        <p>No data to visualize yet</p>
                        <p>Add some data using the Python REPL above</p>
                    `;
                    return;
                }
                
                // Create a simple visualization of the data
                let html = '<div style="text-align: left; font-family: monospace; font-size: 12px;">';
                
                // Show atoms
                html += '<div style="margin-bottom: 15px;"><strong>üì¶ Atoms:</strong><br>';
                atoms.forEach(atom => {
                    html += `<div style="margin: 2px 0; padding: 2px 8px; background: #e3f2fd; border-radius: 3px; display: inline-block; margin-right: 5px;">
                        ${atom.id} : ${atom.type.name}
                    </div>`;
                });
                html += '</div>';
                
                // Show relations
                if (relations.length > 0) {
                    html += '<div><strong>üîó Relations:</strong><br>';
                    relations.forEach(relation => {
                        html += `<div style="margin: 2px 0; padding: 2px 8px; background: #f3e5f5; border-radius: 3px; display: inline-block; margin-right: 5px;">
                            ${relation.source} ‚Üí ${relation.target} (${relation.predicate})
                        </div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<div><strong>üîó Relations:</strong> None</div>';
                }
                
                html += '</div>';
                
                // Add a note about the full graph visualization
                html += `
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 11px;">
                        <strong>üí° Note:</strong> This shows a simplified view of your Python data.<br>
                        The data is compatible with CnD's graph visualization system.
                    </div>
                `;
                
                graphContent.innerHTML = html;
                
                console.log('üéØ Simple graph display updated successfully');
                
            } catch (error) {
                console.error('Failed to update simple graph:', error);
                graphContent.innerHTML = `
                    <p style="color: #dc3545;">Error updating graph display</p>
                    <p style="font-size: 12px;">${error.message}</p>
                `;
            }
        }
        
        /**
         * Toggle collapsible sections
         */
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const isHidden = section.style.display === 'none';
            section.style.display = isHidden ? 'block' : 'none';
            
            // Update arrow direction
            const arrow = section.previousElementSibling?.querySelector('span');
            if (arrow) {
                arrow.textContent = isHidden ? '‚ñº' : '‚ñ∂';
            }
        }

        /**
         * Clear the Python REPL demo
         */
        function clearPythonDemo() {
            const container = document.getElementById('python-repl-demo-container');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <h3>Python REPL Interface with CnD Graph</h3>
                        <p>Click "Start Basic Python REPL" or "Start Enhanced Python REPL" to begin</p>
                    </div>
                `;
            }
        }

        /**
         * Show error message in the container
         */
        function showError(message) {
            const container = document.getElementById('python-repl-demo-container');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #dc3545;">
                        <h3>‚ùå Error</h3>
                        <p>${message}</p>
                        <p><small>Check the browser console for more details.</small></p>
                    </div>
                `;
            }
        }

        /**
         * Load Pyodide evaluator for enhanced Python support
         */
        async function loadPyodideEvaluator() {
            try {
                // Check if Pyodide is already loaded
                if (window.pyodide) {
                    console.log('‚úÖ Using existing Pyodide instance');
                    return createPyodideEvaluator(window.pyodide);
                }
                
                // Load Pyodide from CDN
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
                document.head.appendChild(script);
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                });
                
                console.log('üîÑ Initializing Pyodide...');
                const pyodide = await window.loadPyodide();
                window.pyodide = pyodide;
                
                console.log('‚úÖ Pyodide loaded successfully');
                return createPyodideEvaluator(pyodide);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to load Pyodide, falling back to mock evaluator:', error);
                return createMockPyodideEvaluator();
            }
        }

        /**
         * Create Pyodide evaluator wrapper
         */
        function createPyodideEvaluator(pyodide) {
            return {
                runPython: async (code) => {
                    try {
                        const result = pyodide.runPython(code);
                        return result;
                    } catch (error) {
                        throw new Error(`Python error: ${error.message}`);
                    }
                }
            };
        }

        /**
         * Create mock Pyodide evaluator for demonstration
         */
        function createMockPyodideEvaluator() {
            console.log('üé≠ Using mock Pyodide evaluator for demo');
            return {
                runPython: async (code) => {
                    console.log(`Mock Pyodide running: ${code}`);
                    
                    // Simulate basic Python expressions
                    if (code.includes('[') && code.includes(']')) {
                        // Mock list creation
                        return [1, 2, 3];
                    } else if (code.includes('class ')) {
                        // Mock class definition
                        return { __name__: 'MockClass' };
                    } else if (code.includes('(') && code.includes(')')) {
                        // Mock function call
                        return { 
                            __class__: { __name__: 'MockObject' },
                            name: 'MockValue'
                        };
                    }
                    
                    // Default mock response
                    return code.split('=').pop()?.trim() || 'mock_result';
                }
            };
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Python REPL demo page loaded');
            console.log('Available CnD-Core components:', Object.keys(window.CndCore || {}));
        });
    </script>
</body>
</html>