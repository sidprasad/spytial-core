<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python REPL Demo with CnD-Core</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêç Python REPL Demo with CnD-Core</h1>
        <p>This demo shows the Python REPL Interface with data visualization capabilities.</p>
        
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107;">
            <h3 style="margin-top: 0;">Python Data Instance Features</h3>
            <p>This demo showcases Python-specific functionality for creating and manipulating data instances with familiar Python syntax.</p>
            
            <h4>Try these commands in the REPL:</h4>
            <ul>
                <li><code>x = 1</code> - Basic variable assignment</li>
                <li><code>alice = "Alice"</code> - String assignment</li>
                <li><code>alice:Person</code> - Type annotation</li>
                <li><code>numbers = [1, 2, 3]</code> - List creation (with external evaluator)</li>
            </ul>
            
            <p><strong>Note:</strong> For full Python object support, this demo can optionally use Pyodide or other web Python runtimes.</p>
        </div>
        
        <button onclick="setupBasicPythonDemo()">Start Basic Python REPL</button>
        <button onclick="setupEnhancedPythonDemo()">Start Enhanced Python REPL (with Pyodide)</button>
        <button onclick="clearPythonDemo()">Clear Demo</button>
        
        <div id="python-repl-demo-container" style="height: 600px; border: 1px solid #ddd; border-radius: 8px; margin: 15px 0;">
            <div style="padding: 40px; text-align: center; color: #666;">
                <h3>Python REPL Interface</h3>
                <p>Click "Start Basic Python REPL" or "Start Enhanced Python REPL" to begin</p>
            </div>
        </div>
        
        <div style="background-color: #e8f5e8; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #28a745;">
            <h3 style="margin-top: 0;">Python Commands Overview</h3>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; white-space: pre-line;">
<strong>Basic assignments:</strong>
x = 1
alice = "Alice"  
is_active = True

<strong>Type annotations:</strong>
alice:Person

<strong>With external evaluator (Pyodide):</strong>
my_list = [1, 2, 3]
class Person:
    def __init__(self, name):
        self.name = name

alice = Person("Alice")

<strong>Utility commands:</strong>
info        # Show current instance status
reify       # Generate Python constructor notation
clear       # Clear the instance
help        # Show available commands
            </div>
        </div>
    </div>

    <!-- CnD Core Library (browser build) -->
    <script src="../dist/browser/cnd-core-complete.global.js"></script>
    <link rel="stylesheet" href="../dist/browser/cnd-core-complete.css">

    <script>
        /**
         * Set up basic Python REPL demo (no external evaluator)
         */
        function setupBasicPythonDemo() {
            console.log('üöÄ Setting up basic Python REPL demo...');
            
            // Clear existing content
            clearPythonDemo();
            
            if (!window.CndCore || !window.CndCore.mountPythonRepl) {
                console.error('‚ùå CnD-Core not loaded or mountPythonRepl not available');
                showError('CnD-Core library not loaded or mountPythonRepl not available. Please ensure the built library files are available.');
                return;
            }

            try {
                // Mount the Python REPL using the mounting function
                const success = window.CndCore.mountPythonRepl({
                    containerId: 'python-repl-demo-container',
                    height: '600px',
                    width: '100%',
                    externalEvaluator: null, // No external evaluator for basic demo
                    onChange: (instance) => {
                        console.log('üîÑ Python data updated:', {
                            atoms: instance.getAtoms().length,
                            relations: instance.getRelations().length
                        });
                    },
                    onCndSpecExtracted: (spec) => {
                        console.log('üìê CnD spec extracted:', spec);
                    }
                });
                
                if (success) {
                    console.log('‚úÖ Basic Python REPL demo ready!');
                } else {
                    showError('Failed to mount basic Python REPL');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to setup basic Python REPL:', error);
                showError(`Failed to setup basic Python REPL: ${error.message}`);
            }
        }

        /**
         * Set up enhanced Python REPL demo (with Pyodide)
         */
        async function setupEnhancedPythonDemo() {
            console.log('üöÄ Setting up enhanced Python REPL demo with Pyodide...');
            
            // Clear existing content
            clearPythonDemo();
            
            if (!window.CndCore || !window.CndCore.mountPythonRepl) {
                console.error('‚ùå CnD-Core not loaded or mountPythonRepl not available');
                showError('CnD-Core library not loaded or mountPythonRepl not available. Please ensure the built library files are available.');
                return;
            }

            try {
                const container = document.getElementById('python-repl-demo-container');
                
                // Show loading message
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <h3>üîÑ Loading Pyodide...</h3>
                        <p>This may take a moment on first load</p>
                    </div>
                `;
                
                // Load Pyodide
                const pyodideEvaluator = await loadPyodideEvaluator();
                
                // Mount the Python REPL with Pyodide
                const success = window.CndCore.mountPythonRepl({
                    containerId: 'python-repl-demo-container',
                    height: '600px',
                    width: '100%',
                    externalEvaluator: pyodideEvaluator,
                    onChange: (instance) => {
                        console.log('üîÑ Python data updated:', {
                            atoms: instance.getAtoms().length,
                            relations: instance.getRelations().length
                        });
                    },
                    onCndSpecExtracted: (spec) => {
                        console.log('üìê CnD spec extracted:', spec);
                    }
                });
                
                if (success) {
                    console.log('‚úÖ Enhanced Python REPL demo ready!');
                } else {
                    showError('Failed to mount enhanced Python REPL');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to setup enhanced Python REPL:', error);
                showError(`Failed to setup enhanced Python REPL: ${error.message}`);
            }
        }

        /**
         * Clear the Python REPL demo
         */
        function clearPythonDemo() {
            const container = document.getElementById('python-repl-demo-container');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <h3>Python REPL Interface</h3>
                        <p>Click "Start Basic Python REPL" or "Start Enhanced Python REPL" to begin</p>
                    </div>
                `;
            }
        }

        /**
         * Show error message in the container
         */
        function showError(message) {
            const container = document.getElementById('python-repl-demo-container');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #dc3545;">
                        <h3>‚ùå Error</h3>
                        <p>${message}</p>
                        <p><small>Check the browser console for more details.</small></p>
                    </div>
                `;
            }
        }

        /**
         * Load Pyodide evaluator for enhanced Python support
         */
        async function loadPyodideEvaluator() {
            try {
                // Check if Pyodide is already loaded
                if (window.pyodide) {
                    console.log('‚úÖ Using existing Pyodide instance');
                    return createPyodideEvaluator(window.pyodide);
                }
                
                // Load Pyodide from CDN
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
                document.head.appendChild(script);
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                });
                
                console.log('üîÑ Initializing Pyodide...');
                const pyodide = await window.loadPyodide();
                window.pyodide = pyodide;
                
                console.log('‚úÖ Pyodide loaded successfully');
                return createPyodideEvaluator(pyodide);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to load Pyodide, falling back to mock evaluator:', error);
                return createMockPyodideEvaluator();
            }
        }

        /**
         * Create Pyodide evaluator wrapper
         */
        function createPyodideEvaluator(pyodide) {
            return {
                runPython: async (code) => {
                    try {
                        const result = pyodide.runPython(code);
                        return result;
                    } catch (error) {
                        throw new Error(`Python error: ${error.message}`);
                    }
                }
            };
        }

        /**
         * Create mock Pyodide evaluator for demonstration
         */
        function createMockPyodideEvaluator() {
            console.log('üé≠ Using mock Pyodide evaluator for demo');
            return {
                runPython: async (code) => {
                    console.log(`Mock Pyodide running: ${code}`);
                    
                    // Simulate basic Python expressions
                    if (code.includes('[') && code.includes(']')) {
                        // Mock list creation
                        return [1, 2, 3];
                    } else if (code.includes('class ')) {
                        // Mock class definition
                        return { __name__: 'MockClass' };
                    } else if (code.includes('(') && code.includes(')')) {
                        // Mock function call
                        return { 
                            __class__: { __name__: 'MockObject' },
                            name: 'MockValue'
                        };
                    }
                    
                    // Default mock response
                    return code.split('=').pop()?.trim() || 'mock_result';
                }
            };
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Python REPL demo page loaded');
            console.log('Available CnD-Core components:', Object.keys(window.CndCore || {}));
        });
    </script>
</body>
</html>