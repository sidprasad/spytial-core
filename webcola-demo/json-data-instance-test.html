<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONDataInstance Test Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #005a9e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª JSONDataInstance Test Demo</h1>
        <p>This page tests that <code>CndCore.JSONDataInstance</code> is available and working correctly from the CDN bundle.</p>
        
        <button onclick="runAllTests()">ðŸš€ Run All Tests</button>
        <button onclick="clearResults()">ðŸ§¹ Clear Results</button>
        
        <div id="test-results"></div>
    </div>

    <!-- Load CND Core browser bundle -->
    <script src="../dist/browser/cnd-core-complete.global.js"></script>
    <script>
        let testResults = [];

        function log(title, content, type = 'info') {
            testResults.push({ title, content, type });
            updateDisplay();
        }

        function updateDisplay() {
            const container = document.getElementById('test-results');
            container.innerHTML = testResults.map(result => `
                <div class="test-section ${result.type}">
                    <h3>${result.title}</h3>
                    <pre>${result.content}</pre>
                </div>
            `).join('');
        }

        function clearResults() {
            testResults = [];
            updateDisplay();
        }

        function test1_BasicAvailability() {
            try {
                // Test that CndCore is available
                if (typeof window.CndCore === 'undefined') {
                    throw new Error('CndCore is not available on window');
                }

                // Test that JSONDataInstance is available
                if (typeof CndCore.JSONDataInstance === 'undefined') {
                    throw new Error('JSONDataInstance is not available on CndCore');
                }

                // Test constructor exists
                if (typeof CndCore.JSONDataInstance !== 'function') {
                    throw new Error('JSONDataInstance is not a constructor function');
                }

                log('âœ… Test 1: Basic Availability', 
                    'CndCore.JSONDataInstance is available and is a constructor function', 
                    'success');
                return true;
            } catch (error) {
                log('âŒ Test 1: Basic Availability', 
                    `FAILED: ${error.message}`, 
                    'error');
                return false;
            }
        }

        function test2_BasicConstruction() {
            try {
                const jsonData = {
                    atoms: [
                        { id: "person1", type: "Person", label: "Alice" },
                        { id: "person2", type: "Person", label: "Bob" }
                    ],
                    relations: [
                        {
                            id: "friendship", 
                            name: "friends", 
                            types: ["Person", "Person"],
                            tuples: [{ atoms: ["person1", "person2"], types: ["Person", "Person"] }]
                        }
                    ]
                };

                const instance = new CndCore.JSONDataInstance(jsonData);
                
                // Test basic methods
                const atoms = instance.getAtoms();
                const relations = instance.getRelations();
                const types = instance.getTypes();

                const result = {
                    atomCount: atoms.length,
                    relationCount: relations.length,
                    typeCount: types.length,
                    isValid: instance.isValid(),
                    errors: instance.getErrors()
                };

                log('âœ… Test 2: Basic Construction', 
                    JSON.stringify(result, null, 2), 
                    'success');
                return true;
            } catch (error) {
                log('âŒ Test 2: Basic Construction', 
                    `FAILED: ${error.message}\n${error.stack}`, 
                    'error');
                return false;
            }
        }

        function test3_JSONStringInput() {
            try {
                const jsonString = JSON.stringify({
                    atoms: [
                        { id: "car1", type: "Car", label: "Toyota Camry" },
                        { id: "person1", type: "Person", label: "John" }
                    ],
                    relations: [
                        {
                            id: "ownership",
                            name: "owns",
                            types: ["Person", "Car"],
                            tuples: [{ atoms: ["person1", "car1"], types: ["Person", "Car"] }]
                        }
                    ]
                });

                const instance = new CndCore.JSONDataInstance(jsonString);
                const statistics = instance.getStatistics();

                log('âœ… Test 3: JSON String Input', 
                    `Successfully created instance from JSON string:\n${JSON.stringify(statistics, null, 2)}`, 
                    'success');
                return true;
            } catch (error) {
                log('âŒ Test 3: JSON String Input', 
                    `FAILED: ${error.message}`, 
                    'error');
                return false;
            }
        }

        function test4_Normalization() {
            try {
                const jsonData = {
                    atoms: [
                        { id: "p1", type: "Person", label: "Alice" },
                        { id: "p1", type: "Person", label: "Alice Duplicate" }, // duplicate
                        { id: "p2", type: "Person", label: "Bob" }
                    ],
                    relations: [
                        {
                            id: "rel1",
                            name: "knows",
                            types: ["Person"],
                            tuples: [{ atoms: ["p1", "p2"], types: ["Person", "Person"] }]
                        },
                        {
                            id: "rel2", 
                            name: "knows", // same name, should be merged
                            types: ["Person"],
                            tuples: [{ atoms: ["p2", "p1"], types: ["Person", "Person"] }]
                        }
                    ]
                };

                const instance = new CndCore.JSONDataInstance(jsonData);
                const errors = instance.getErrors();
                const relations = instance.getRelations();

                const result = {
                    normalizationErrors: errors,
                    relationCount: relations.length,
                    tupleCountInFirstRelation: relations[0]?.tuples.length || 0
                };

                log('âœ… Test 4: Normalization', 
                    `Normalization worked:\n${JSON.stringify(result, null, 2)}`, 
                    'success');
                return true;
            } catch (error) {
                log('âŒ Test 4: Normalization', 
                    `FAILED: ${error.message}`, 
                    'error');
                return false;
            }
        }

        function test5_AddRemoveOperations() {
            try {
                const instance = new CndCore.JSONDataInstance({
                    atoms: [{ id: "a1", type: "Entity", label: "Initial" }],
                    relations: []
                });

                // Test adding atom
                instance.addAtom({ id: "a2", type: "Entity", label: "Added" });
                
                // Test adding relation tuple
                instance.addRelationTuple("connection", {
                    atoms: ["a1", "a2"],
                    types: ["Entity", "Entity"]
                });

                // Test statistics
                const beforeRemove = instance.getStatistics();

                // Test removing atom
                instance.removeAtom("a2");

                const afterRemove = instance.getStatistics();

                const result = {
                    beforeRemove,
                    afterRemove,
                    testPassed: beforeRemove.atomCount === 2 && afterRemove.atomCount === 1
                };

                log('âœ… Test 5: Add/Remove Operations', 
                    `Add/Remove operations work:\n${JSON.stringify(result, null, 2)}`, 
                    'success');
                return true;
            } catch (error) {
                log('âŒ Test 5: Add/Remove Operations', 
                    `FAILED: ${error.message}`, 
                    'error');
                return false;
            }
        }

        function test6_ReifyClone() {
            try {
                const originalData = {
                    atoms: [{ id: "test", type: "Test", label: "Original" }],
                    relations: []
                };

                const instance = new CndCore.JSONDataInstance(originalData);
                
                // Test reify
                const reified = instance.reify();
                
                // Test clone
                const cloned = instance.clone();

                // Modify original instance
                instance.addAtom({ id: "new", type: "Test", label: "New" });

                const result = {
                    originalHasNewAtom: instance.getAtoms().length === 2,
                    clonedStillOriginal: cloned.getAtoms().length === 1,
                    reifiedStructure: Object.keys(reified)
                };

                log('âœ… Test 6: Reify & Clone', 
                    `Reify and Clone work correctly:\n${JSON.stringify(result, null, 2)}`, 
                    'success');
                return true;
            } catch (error) {
                log('âŒ Test 6: Reify & Clone', 
                    `FAILED: ${error.message}`, 
                    'error');
                return false;
            }
        }

        function test7_ValidationErrors() {
            try {
                const badData = {
                    atoms: [{ id: "a1", type: "Entity", label: "Atom 1" }],
                    relations: [{
                        id: "bad_rel",
                        name: "badRelation",
                        types: ["Entity"],
                        tuples: [{ 
                            atoms: ["a1", "missing_atom"], // references non-existent atom
                            types: ["Entity", "Entity"] 
                        }]
                    }]
                };

                const instance = new CndCore.JSONDataInstance(badData);
                const errors = instance.getErrors();
                const isValid = instance.isValid();

                const result = {
                    isValid,
                    errorCount: errors.length,
                    errors: errors
                };

                log('âœ… Test 7: Validation Errors', 
                    `Validation correctly caught errors:\n${JSON.stringify(result, null, 2)}`, 
                    isValid ? 'error' : 'success'); // Should NOT be valid
                return !isValid; // Test passes if instance is invalid
            } catch (error) {
                log('âŒ Test 7: Validation Errors', 
                    `FAILED: ${error.message}`, 
                    'error');
                return false;
            }
        }

        function runAllTests() {
            clearResults();
            
            log('ðŸš€ Starting JSONDataInstance Tests', 
                'Running comprehensive tests for CndCore.JSONDataInstance...', 
                'info');

            const tests = [
                test1_BasicAvailability,
                test2_BasicConstruction,
                test3_JSONStringInput,
                test4_Normalization,
                test5_AddRemoveOperations,
                test6_ReifyClone,
                test7_ValidationErrors
            ];

            let passed = 0;
            let failed = 0;

            tests.forEach(test => {
                if (test()) {
                    passed++;
                } else {
                    failed++;
                }
            });

            const summary = `
Tests completed:
âœ… Passed: ${passed}
âŒ Failed: ${failed}
ðŸ“Š Total: ${tests.length}

${failed === 0 ? 'ðŸŽ‰ All tests passed! JSONDataInstance is working correctly.' : 
  'âš ï¸ Some tests failed. Check the errors above.'}`;

            log('ðŸ“‹ Test Summary', summary, failed === 0 ? 'success' : 'error');
        }

        // Auto-run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500); // Small delay to ensure everything is loaded
        });
    </script>
</body>
</html>
