<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symmetric Edge Collapse Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .demo-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .demo-section h2 {
            color: #555;
            margin-top: 0;
        }
        .description {
            background-color: #e8f5e9;
            padding: 10px;
            border-left: 4px solid #4CAF50;
            margin: 10px 0;
        }
        #graph-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-arrow {
            width: 40px;
            height: 2px;
            background: black;
            position: relative;
        }
        .legend-arrow::after {
            content: '';
            position: absolute;
            right: -5px;
            top: -3px;
            width: 0;
            height: 0;
            border-left: 8px solid black;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }
        .legend-arrow.bidirectional::before {
            content: '';
            position: absolute;
            left: -5px;
            top: -3px;
            width: 0;
            height: 0;
            border-right: 8px solid black;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Symmetric Edge Collapse Demo</h1>
        
        <div class="description">
            <strong>Feature:</strong> When two nodes have edges between them with the <strong>same label</strong>, 
            they are automatically collapsed into a single bidirectional edge (arrows on both ends).
            <br><br>
            <strong>Important:</strong> Edges with <strong>different labels</strong> are NOT collapsed and remain as separate edges.
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-arrow"></div>
                <span>Unidirectional edge</span>
            </div>
            <div class="legend-item">
                <div class="legend-arrow bidirectional"></div>
                <span>Bidirectional edge (collapsed from two edges with same label)</span>
            </div>
        </div>

        <div class="demo-section">
            <h2>Test Cases Demonstrated:</h2>
            <ol>
                <li><strong>A ↔ B (label: "friend")</strong> - Two edges with same label collapsed into one bidirectional edge</li>
                <li><strong>C → D (label: "manager")</strong> and <strong>D → C (label: "reports to")</strong> - Different labels, NOT collapsed</li>
                <li><strong>E → F (label: "knows")</strong> - Single edge, remains unidirectional</li>
            </ol>
        </div>

        <div id="graph-container">
            <webcola-cnd-graph id="demo-graph"></webcola-cnd-graph>
        </div>
    </div>

    <script type="module">
        import { JSONDataInstance } from '../dist/index.mjs';
        import { parseLayoutSpec } from '../dist/index.mjs';
        import { LayoutInstance } from '../dist/index.mjs';
        import { SGraphQueryEvaluator } from '../dist/index.mjs';
        import { WebColaTranslator } from '../dist/index.mjs';

        // Create test data with symmetric edges
        const jsonData = {
            atoms: [
                { id: 'A', type: 'Person', label: 'Alice' },
                { id: 'B', type: 'Person', label: 'Bob' },
                { id: 'C', type: 'Person', label: 'Carol' },
                { id: 'D', type: 'Person', label: 'Dave' },
                { id: 'E', type: 'Person', label: 'Eve' },
                { id: 'F', type: 'Person', label: 'Frank' }
            ],
            relations: [
                {
                    id: 'friend',
                    name: 'friend',
                    types: ['Person', 'Person'],
                    tuples: [
                        { atoms: ['A', 'B'], types: ['Person', 'Person'] },  // A -> B
                        { atoms: ['B', 'A'], types: ['Person', 'Person'] }   // B -> A (should collapse)
                    ]
                },
                {
                    id: 'manager',
                    name: 'manager',
                    types: ['Person', 'Person'],
                    tuples: [
                        { atoms: ['C', 'D'], types: ['Person', 'Person'] }   // C -> D
                    ]
                },
                {
                    id: 'reports_to',
                    name: 'reports to',
                    types: ['Person', 'Person'],
                    tuples: [
                        { atoms: ['D', 'C'], types: ['Person', 'Person'] }   // D -> C (different label, should NOT collapse)
                    ]
                },
                {
                    id: 'knows',
                    name: 'knows',
                    types: ['Person', 'Person'],
                    tuples: [
                        { atoms: ['E', 'F'], types: ['Person', 'Person'] }   // E -> F (single edge)
                    ]
                }
            ]
        };

        const layoutSpecStr = `
constraints:
  - orientation:
      selector: friend
      directions:
        - right
  - orientation:
      selector: manager
      directions:
        - below
`;

        async function initializeDemo() {
            try {
                const instance = new JSONDataInstance(jsonData);
                const layoutSpec = parseLayoutSpec(layoutSpecStr);
                const evaluator = new SGraphQueryEvaluator();
                evaluator.initialize({ sourceData: instance });

                const layoutInstance = new LayoutInstance(layoutSpec, evaluator, 0, true);
                const { layout } = layoutInstance.generateLayout(instance, {});

                const translator = new WebColaTranslator();
                const webcolaLayout = await translator.translate(layout, 600, 800);

                console.log('Number of edges before collapse:', layout.edges.length);
                console.log('Number of edges after collapse:', webcolaLayout.links.length);
                console.log('Bidirectional edges:', webcolaLayout.links.filter(e => e.bidirectional).map(e => ({
                    id: e.id,
                    label: e.label,
                    bidirectional: e.bidirectional
                })));

                const graphElement = document.getElementById('demo-graph');
                graphElement.renderLayout(webcolaLayout);

            } catch (error) {
                console.error('Error initializing demo:', error);
                document.getElementById('graph-container').innerHTML = 
                    '<div style="color: red; padding: 20px;">Error: ' + error.message + '</div>';
            }
        }

        // Initialize when the page loads
        window.addEventListener('load', initializeDemo);
    </script>
</body>
</html>
