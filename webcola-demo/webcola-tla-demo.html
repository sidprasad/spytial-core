<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebCola TLA+ Trace Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 18px;
    }
    textarea {
      width: 100%;
      min-height: 160px;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      box-sizing: border-box;
      background: #fafafa;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #0056b3; }
    .status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 6px;
      background: #e3f2fd;
      color: #0d47a1;
    }
    #tla-demo-container {
      height: 780px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 16px;
      background: white;
    }
    #graph-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    #graph-controls select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebCola TLA+ Trace Demo</h1>
    <p>
      Paste a TLA+ trace export (e.g., the JSON from Apalache/TLC) and a CnD layout
      specification. The page runs the same Alloy-style pipeline: <code>TlaDataInstance</code>
      → <code>SGraphQueryEvaluator</code> (SGQ) → <code>LayoutInstance</code> →
      <code>&lt;webcola-cnd-graph&gt;</code>. No CombinedInput wrapper required.
    </p>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;">
      <div>
        <h3>Trace JSON</h3>
        <textarea id="tla-trace" aria-label="TLA+ trace JSON"></textarea>
        <p style="margin-top: 6px; color: #555;">
          Expect the standard <code>{ states: [...], loop?: number }</code> shape. Each state
          maps variable names to values (optionally tagged with <code>type</code>), mirroring the
          DOT-style state graphs most TLA+ tools export.
        </p>
      </div>
      <div>
        <h3>Layout Specification</h3>
        <textarea id="tla-cnd" aria-label="CnD layout spec"></textarea>
      </div>
    </div>

    <div style="margin-top: 12px; display: flex; align-items: center; gap: 12px;">
      <button onclick="runTlaPipeline()">Apply Layout</button>
      <button onclick="resetTlaInputs()" style="background:#6c757d;">Reset Sample</button>
      <button onclick="clearTlaGraph()" style="background:#dc3545;">Clear Graph</button>
      <div id="tla-status" class="status">Ready to load sample trace.</div>
    </div>

    <div id="graph-controls">
      <label for="layoutFormat">Layout:</label>
      <select id="layoutFormat" onchange="changeLayoutFormat()">
        <option value="default" selected>Standard</option>
        <option value="grid">Grid (beta)</option>
      </select>
    </div>

    <div id="tla-demo-container">
      <webcola-cnd-graph
        id="tla-graph"
        width="1000"
        height="720"
        layoutFormat="default"
        aria-label="TLA+ graph">
      </webcola-cnd-graph>
    </div>

    <div id="relation-highlighter-mount" class="container" style="margin-top: 12px;"></div>
    <div id="error-messages"></div>

    <div class="container" style="margin-top: 18px;">
      <h3>SGQ REPL</h3>
      <p class="text-muted" style="margin-top: -6px;">Runs Simple Graph Query expressions against the current TLA+ data instance.</p>
      <div id="tla-repl"></div>
    </div>
  </div>

  <!-- D3 v4 and WebCola - the working combination -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="../vendor/cola.js"></script>

  <!-- Spytial Core Library (browser build) -->
  <script src="../dist/browser/spytial-core-complete.global.js"></script>
  <link rel="stylesheet" href="../dist/browser/spytial-core-complete.css">

  <!-- React component helpers (REPL, highlighter, error modal) -->
  <script src="../dist/components/react-component-integration.global.js"></script>
  <link rel="stylesheet" href="../dist/components/react-component-integration.css">

  <script>
    const SAMPLE_TRACE = JSON.stringify({
      states: [
        {
          name: 'Init',
          variables: {
            pc: { value: 'Init', type: 'Str' },
            counter: { value: 0, type: 'Int' },
            locked: { value: false, type: 'Bool' }
          }
        },
        {
          name: 'Tick',
          variables: {
            pc: { value: 'Step', type: 'Str' },
            counter: { value: 1, type: 'Int' },
            locked: { value: true, type: 'Bool' }
          }
        },
        {
          name: 'Loop',
          variables: {
            pc: { value: 'Step', type: 'Str' },
            counter: { value: 2, type: 'Int' },
            locked: { value: false, type: 'Bool' }
          }
        }
      ],
      loop: 1
    }, null, 2);

    const SAMPLE_CND = `constraints:\n  - orientation:\n      selector: Next\n      directions:\n        - right\ndirectives:\n  - flag: hideDisconnectedBuiltIns\n  - flag: hideDisconnected\n  - label:\n      selector: State\n      property: name`;

    let tlaDataInstance = null;
    let sgqEvaluator = null;
    let layoutSpec = null;
    let currentLayout = null;

    /** Reset inputs back to the baked-in samples. */
    function resetTlaInputs() {
      document.getElementById('tla-trace').value = SAMPLE_TRACE;
      document.getElementById('tla-cnd').value = SAMPLE_CND;
      updateTlaStatus('Ready to load sample trace.', 'info');
      clearTlaGraph();
    }

    /** Update the status banner. */
    function updateTlaStatus(message, type = 'info') {
      const statusEl = document.getElementById('tla-status');
      statusEl.textContent = message;
      statusEl.style.background = type === 'error' ? '#ffebee' : '#e3f2fd';
      statusEl.style.color = type === 'error' ? '#c62828' : '#0d47a1';
    }

    /** Change the layout format on the fly. */
    async function changeLayoutFormat() {
      const graphElement = document.getElementById('tla-graph');
      const layoutFormat = document.getElementById('layoutFormat').value;
      graphElement.setAttribute('layoutFormat', layoutFormat);

      if (currentLayout) {
        await graphElement.renderLayout(currentLayout);
      }
    }

    /** Clear the rendered graph. */
    function clearTlaGraph() {
      const graphElement = document.getElementById('tla-graph');
      if (graphElement?.clear) {
        graphElement.clear();
      }
      currentLayout = null;
    }

    /** Kick off the TLA+ pipeline without the CombinedInput wrapper. */
    async function runTlaPipeline() {
      try {
        updateTlaStatus('Parsing TLA+ trace...', 'info');
        const traceText = document.getElementById('tla-trace').value.trim();
        const cndSpec = document.getElementById('tla-cnd').value.trim();

        if (!traceText) {
          throw new Error('Please paste a TLA+ trace JSON document.');
        }
        if (!cndSpec) {
          throw new Error('Please provide a CnD layout specification.');
        }

        const trace = JSON.parse(traceText);
        tlaDataInstance = new window.CndCore.TlaDataInstance(trace);

        updateTlaStatus('Initializing SGQ evaluator...', 'info');
        sgqEvaluator = new window.CndCore.SGraphQueryEvaluator();
        sgqEvaluator.initialize({ sourceData: tlaDataInstance });

        // Mount REPL to inspect selectors
        if (window.mountEvaluatorRepl) {
          window.mountEvaluatorRepl('tla-repl', sgqEvaluator, 0);
        }

        updateTlaStatus('Parsing layout specification...', 'info');
        try {
          layoutSpec = window.CndCore.parseLayoutSpec(cndSpec);
          if (window.clearAllErrors) {
            window.clearAllErrors();
          }
        } catch (error) {
          if (window.showParseError) {
            window.showParseError(error.message, 'Layout Specification');
          }
          throw error;
        }

        updateTlaStatus('Generating layout with SGQ evaluator...', 'info');
        const layoutInstance = new window.CndCore.LayoutInstance(layoutSpec, sgqEvaluator, 0, true);
        const layoutResult = layoutInstance.generateLayout(tlaDataInstance, {});

        if (layoutResult.error) {
          if (layoutResult.error.errorMessages && window.showPositionalError) {
            window.showPositionalError(layoutResult.error.errorMessages);
          } else if (layoutResult.error.overlappingNodes && window.showGroupOverlapError) {
            window.showGroupOverlapError(layoutResult.error.message);
          } else if (window.showGeneralError) {
            window.showGeneralError(`Layout generation error: ${layoutResult.error.message}`);
          }
          throw new Error(layoutResult.error.message);
        }

        currentLayout = layoutResult.layout;

        updateTlaStatus('Rendering WebCola graph...', 'info');
        const graphElement = document.getElementById('tla-graph');
        await graphElement.renderLayout(currentLayout);
        updateTlaStatus('TLA+ graph rendered. Adjust the trace or layout spec to iterate.', 'success');
      } catch (error) {
        console.error('Failed to run TLA demo', error);
        updateTlaStatus(`Error: ${error.message}`, 'error');
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      resetTlaInputs();
      if (window.mountRelationHighlighter) {
        window.mountRelationHighlighter('relation-highlighter-mount', 'tla-graph');
      }
      if (window.mountErrorMessageModal) {
        window.mountErrorMessageModal('error-messages');
      }
    });
  </script>
</body>
</html>
