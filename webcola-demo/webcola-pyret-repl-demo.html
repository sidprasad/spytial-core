<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Input Component Demo</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Combined Input Component Demo</h1>
        <p>This demo shows the Combined Input Component with REPL, Layout Interface, and Graph visualization.</p>
        
        <div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #2196f3;">
            <h3 style="margin-top: 0;">CnD Specification Extraction</h3>
            <p>This demo includes automatic CnD specification extraction functionality. When you evaluate Pyret expressions that have a <code>_cndspec</code> method, the system will automatically extract the CnD specification and compose it with existing specs.</p>
            
            <h4>Try these commands in the REPL:</h4>
            <ul>
                <li><code>Alice:Person</code> - Basic data structure</li>
                <li><code>alice.friend=bob</code> - Relations</li>
                <li><code>Black(42, empty, empty)</code> - Extract orientation constraints</li>
                <li><code>tree(root, [])</code> - Extract hierarchy constraints</li>
            </ul>
            
            <p><strong>Note:</strong> This demo simulates Pyret objects with <code>_cndspec</code> methods for demonstration purposes.</p>
        </div>
        
        <button onclick="setupCombinedInputDemo()">Start Demo</button>
        <button onclick="clearCombinedInputDemo()">Clear Demo</button>
        
        <div id="combined-input-demo-container" style="height: 800px; border: 1px solid #ddd; border-radius: 8px; margin: 15px 0;">
            <div style="padding: 40px; text-align: center; color: #666;">
                <h3>Combined Input Component</h3>
                <p>Click "Start Demo" to see the Combined Input Component</p>
            </div>
        </div>
    </div>

    <!-- CnD Core Library (browser build) -->
    <script src="../dist/browser/cnd-core-complete.global.js"></script>
    <link rel="stylesheet" href="../dist/browser/cnd-core-complete.css">

    <script>
        /**
         * Set up the Combined Input Component demo
         */
        function setupCombinedInputDemo() {
            console.log('üöÄ Setting up Combined Input Component demo...');
            
            // Clear existing content
            clearCombinedInputDemo();
            
            // Check for external evaluator
            const externalEvaluator = window.__internalRepl || window.pyretREPLInternal;
            
            // Create empty data instance (no initial data)
            const dataInstance = new window.CndCore.PyretDataInstance({
                dict: {},
                brands: {}
            });
            
            // Start with empty CnD specification
            const cndSpec = ``;

            // Mount the combined input component
            const success = window.CndCore.mountCombinedInput({
                containerId: 'combined-input-demo-container',
                cndSpec: cndSpec,
                dataInstance: dataInstance,
                pyretEvaluator: externalEvaluator || createMockEvaluator(),
                height: '800px',
                showLayoutInterface: true,
                autoApplyLayout: true,
                onInstanceChange: (instance) => {
                    console.log('üîÑ Data updated:', {
                        atoms: instance.getAtoms().length,
                        relations: instance.getRelations().length
                    });
                },
                onSpecChange: (spec) => {
                    console.log('üìê Layout spec updated');
                },
                onLayoutApplied: (layout) => {
                    console.log('üé® Layout applied');
                }
            });
            
            if (success) {
                console.log('‚úÖ Combined Input Component demo ready!');
            } else {
                console.error('‚ùå Failed to setup Combined Input Component demo');
            }
        }

        /**
         * Clear the combined input demo
         */
        function clearCombinedInputDemo() {
            const container = document.getElementById('combined-input-demo-container');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <h3>Combined Input Component</h3>
                        <p>Click "Start Demo" to see the Combined Input Component</p>
                    </div>
                `;
            }
        }

        /**
         * Create a mock evaluator for demo purposes with CnD spec extraction support
         */
        function createMockEvaluator() {
            return {
                run: async (code, sourceLocation) => {
                    console.log(`Mock evaluator running: ${code}`);
                    
                    // Handle CnD spec extraction calls
                    if (code.includes('._cndspec()')) {
                        if (code.includes('Black(') || code.includes('Red(')) {
                            return {
                                success: true,
                                result: `constraints:
  - orientation:
      selector: right
      directions:
        - right
        - below`
                            };
                        } else if (code.includes('tree(')) {
                            return {
                                success: true,
                                result: `constraints:
  - hierarchy:
      selector: children
      type: tree`
                            };
                        }
                        // Default case - no spec
                        return { success: false };
                    }
                    
                    // Simulate Pyret objects with _cndspec methods for demo
                    if (code.includes('Black(') || code.includes('Red(')) {
                        return {
                            success: true,
                            result: {
                                value: 42,
                                left: null,
                                right: null,
                                _cndspec: function() {
                                    return `constraints:
  - orientation:
      selector: right
      directions:
        - right
        - below`;
                                }
                            }
                        };
                    } else if (code.includes('tree(')) {
                        return {
                            success: true,
                            result: {
                                root: 'value',
                                children: [],
                                _cndspec: function() {
                                    return `constraints:
  - hierarchy:
      selector: children
      type: tree`;
                                }
                            }
                        };
                    }
                    
                    // Default mock response
                    return {
                        success: true,
                        result: {
                            dict: { value: Math.random() * 100 },
                            brands: { '$brandmock': true }
                        }
                    };
                },
                runtime: {
                    isSuccessResult: (result) => result.success === true
                }
            };
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Combined Input Component demo page loaded');
        });
    </script>
</body>
</html>