<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Pyret Reification Demo</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .demo-section {
            margin-bottom: 30px;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .output {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 10px;
            margin: 10px 0;
        }
        .error {
            background: #ffe8e8;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 10px 0;
        }
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .repl-demo {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .repl-prompt {
            color: #50fa7b;
        }
        .repl-output {
            color: #8be9fd;
            margin: 5px 0;
        }
        .repl-error {
            color: #ff5555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced Pyret Reification Demo</h1>
        <p>This demo showcases the new enhanced reification functionality for Pyret data instances, 
           solving the argument ordering problem when converting data back to Pyret constructor notation.</p>
    </div>

    <div class="container">
        <h2>üéØ The Problem</h2>
        <p>When we build Pyret data structures through REPL commands or manual construction, 
           we lose the original object structure that preserves constructor argument order.</p>
        
        <div class="demo-section">
            <h3>Original Problem Example:</h3>
            <div class="code-block">
// Manual construction (like through REPL):
instance.addAtom({ id: 'node1', type: 'Node', label: 'Node$1' });
instance.addAtom({ id: 'val1', type: 'Number', label: '5' });
instance.addRelationTuple('value', { atoms: ['node1', 'val1'], types: ['Node', 'Number'] });

// Question: Should this reify as Node(5) or Node(value: 5)?
// How do we know the correct argument order?
            </div>
        </div>
    </div>

    <div class="container">
        <h2>‚ú® The Solution</h2>
        <p>Our enhanced reification system uses multiple strategies to determine correct argument order:</p>
        
        <div class="demo-section">
            <h3>1. Schema-Based Ordering</h3>
            <div class="code-block">
const schemas = [
  {
    typeName: 'Node',
    argumentFields: ['value', 'left', 'right'],
    examples: ['Node(5, Leaf(0), Leaf(0))']
  }
];

// Now reification knows: Node args should be in order: value, left, right
            </div>
        </div>

        <div class="demo-section">
            <h3>2. Heuristic-Based Fallbacks</h3>
            <div class="code-block">
// Common Pyret patterns are automatically recognized:
// Binary trees: value, left, right
// Lists: first, rest  
// Linked lists: data, next
// Priority order: value, data, first, second, left, right, rest, next
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üöÄ REPL Commands</h2>
        <div class="repl-demo" id="repl-demo">
            <div class="repl-prompt">cnd-repl> </div>
            <div>Enhanced Pyret Reification Demo - Try the commands below!</div>
            <div class="repl-prompt">cnd-repl> </div>
        </div>
        
        <div style="margin-top: 10px;">
            <button onclick="runDemo('setup')">Setup Example Data</button>
            <button onclick="runDemo('reify')">reify</button>
            <button onclick="runDemo('structure')">show-structure</button>
            <button onclick="runDemo('schemas')">show-schemas</button>
            <button onclick="runDemo('format')">reify --format</button>
            <button onclick="runDemo('clear')">Clear REPL</button>
        </div>
    </div>

    <div class="container">
        <h2>üìä Before vs After</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3>‚ùå Before (Limited)</h3>
                <div class="code-block">
// Only worked with original Pyret objects
const result = instance.reify();
// Would return: "Node" (just type name)
// Or: "/* No root atoms found */"
                </div>
            </div>
            
            <div>
                <h3>‚úÖ After (Enhanced)</h3>
                <div class="code-block">
// Works with any data source
const result = instance.reifyWithOptions({
  schemas: [...],
  formatOutput: true,
  useHeuristics: true
});
// Returns: "Node(5, Leaf(3), Leaf(7))"
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üîß Integration Example</h2>
        <div class="code-block">
import { 
  PyretDataInstance, 
  createReificationHelper,
  ReificationCommandParser 
} from 'cnd-core';

// 1. Create instance from REPL commands
const instance = new PyretDataInstance(null);
instance.addAtom({ id: 'n1', type: 'Node', label: 'Node$1' });
instance.addAtom({ id: 'v1', type: 'Number', label: '5' });
instance.addRelationTuple('value', { 
  atoms: ['n1', 'v1'], 
  types: ['Node', 'Number'] 
});

// 2. Enhanced reification with schemas
const helper = createReificationHelper(instance, {
  schemas: [{ 
    typeName: 'Node', 
    argumentFields: ['value', 'left', 'right'] 
  }],
  formatOutput: true
});

console.log(helper.reify()); // "Node(5)"

// 3. REPL integration
const parser = new ReificationCommandParser();
const result = parser.execute('reify --format', instance);
console.log(result.message); // "Reified instance:\nNode(5)"
        </div>
    </div>

    <div class="container">
        <h2>üéâ Benefits</h2>
        <ul>
            <li><strong>Backward Compatible</strong>: Existing code continues to work unchanged</li>
            <li><strong>Smart Fallbacks</strong>: Multiple strategies ensure correct ordering</li>
            <li><strong>REPL Integration</strong>: Interactive commands for exploration</li>
            <li><strong>Schema Support</strong>: Define custom argument ordering</li>
            <li><strong>Debug Features</strong>: Troubleshooting with debug comments</li>
            <li><strong>Format Options</strong>: Multi-line output for complex structures</li>
        </ul>
    </div>

    <script>
        // Demo data
        let demoInstance = null;
        
        // Mock the enhanced reification functionality for demo purposes
        function initializeDemoData() {
            demoInstance = {
                atoms: [
                    { id: 'node1', type: 'Node', label: 'Node$1' },
                    { id: 'val1', type: 'Number', label: '5' },
                    { id: 'leaf1', type: 'Leaf', label: 'Leaf$1' },
                    { id: 'val2', type: 'Number', label: '3' }
                ],
                relations: [
                    { name: 'value', tuples: [{ atoms: ['node1', 'val1'] }, { atoms: ['leaf1', 'val2'] }] },
                    { name: 'left', tuples: [{ atoms: ['node1', 'leaf1'] }] }
                ]
            };
        }
        
        function addToRepl(text, className = 'repl-output') {
            const repl = document.getElementById('repl-demo');
            const div = document.createElement('div');
            div.className = className;
            div.textContent = text;
            repl.appendChild(div);
            repl.scrollTop = repl.scrollHeight;
        }
        
        function addPrompt() {
            const repl = document.getElementById('repl-demo');
            const div = document.createElement('div');
            div.className = 'repl-prompt';
            div.textContent = 'cnd-repl> ';
            repl.appendChild(div);
            repl.scrollTop = repl.scrollHeight;
        }
        
        function runDemo(command) {
            if (!demoInstance) {
                initializeDemoData();
            }
            
            switch(command) {
                case 'setup':
                    addToRepl('Setting up example data...');
                    addToRepl('add Node$1:Node');
                    addToRepl('‚úì Added atom: node1 (Node$1)');
                    addToRepl('add value(node1, 5)');
                    addToRepl('‚úì Added relation: value');
                    addToRepl('add left(node1, leaf1)'); 
                    addToRepl('‚úì Added relation: left');
                    addPrompt();
                    break;
                    
                case 'reify':
                    addToRepl('reify');
                    addToRepl('Reified instance:');
                    addToRepl('Node(5, Leaf(3))');
                    addPrompt();
                    break;
                    
                case 'structure':
                    addToRepl('show-structure');
                    addToRepl('Data Structure Overview:');
                    addToRepl('  Atoms: 4');
                    addToRepl('  Relations: 2');
                    addToRepl('  Types: 2');
                    addToRepl('');
                    addToRepl('Types:');
                    addToRepl('  Node: 1 atoms');
                    addToRepl('    - node1 (Node$1)');
                    addToRepl('  Leaf: 1 atoms');
                    addToRepl('    - leaf1 (Leaf$1)');
                    addToRepl('  Number: 2 atoms');
                    addToRepl('    - val1 (5)');
                    addToRepl('    - val2 (3)');
                    addPrompt();
                    break;
                    
                case 'schemas':
                    addToRepl('show-schemas');
                    addToRepl('Available Type Schemas:');
                    addToRepl('');
                    addToRepl('Node:');
                    addToRepl('  Arguments: value, left, right');
                    addToRepl('  Examples:');
                    addToRepl('    Node(10, Leaf(5), Leaf(15))');
                    addToRepl('');
                    addToRepl('Leaf:');
                    addToRepl('  Arguments: value');
                    addToRepl('  Examples:');
                    addToRepl('    Leaf(42)');
                    addPrompt();
                    break;
                    
                case 'format':
                    addToRepl('reify --format');
                    addToRepl('Reified instance:');
                    addToRepl('Node(');
                    addToRepl('  5,');
                    addToRepl('  Leaf(3)');
                    addToRepl(')');
                    addPrompt();
                    break;
                    
                case 'clear':
                    document.getElementById('repl-demo').innerHTML = `
                        <div class="repl-prompt">cnd-repl> </div>
                        <div>Enhanced Pyret Reification Demo - Try the commands below!</div>
                        <div class="repl-prompt">cnd-repl> </div>
                    `;
                    break;
            }
        }
        
        // Initialize demo
        initializeDemoData();
    </script>
</body>
</html>