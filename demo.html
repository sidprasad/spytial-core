<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CND-Core Demo - Real Layout Generation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .demo-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background-color: #005a9e;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background-color: #e6ffe6;
            border-color: #00b894;
            color: #00b894;
        }
        .error {
            background-color: #ffe6e6;
            border-color: #ff6b6b;
            color: #d63031;
        }
        .info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .code-sample {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üöÄ CND-Core Real Demo</h1>
    <p>This demo uses the actual built cnd-core library to demonstrate layout generation from Alloy instances.</p>
    
    <div class="info">
        <h3>üìã What This Demo Shows</h3>
        <ul>
            <li><strong>setupLayout</strong> - Main API for layout generation</li>
            <li><strong>LayoutInstance</strong> - Core layout class</li>
            <li><strong>IEvaluator</strong> - Evaluator interface</li>
            <li><strong>Alloy XML parsing</strong> - Real data processing</li>
            <li><strong>CND specification parsing</strong> - YAML layout specs</li>
        </ul>
    </div>

    <div class="container">
        <h3>ÔøΩ Custom Input</h3>
        <p>Provide your own Alloy instance and CND specification to test:</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label for="custom-alloy" style="font-weight: bold; display: block; margin-bottom: 5px;">Alloy Instance (XML):</label>
                <textarea id="custom-alloy" style="width: 100%; height: 200px; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" placeholder="Loading sample Alloy XML...">
Loading sample data from sample/datum.xml...
                </textarea>
            </div>
            <div>
                <label for="custom-cnd" style="font-weight: bold; display: block; margin-bottom: 5px;">CND Layout Specification (YAML):</label>
                <textarea id="custom-cnd" style="width: 100%; height: 200px; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" placeholder="Loading sample CND layout...">
Loading sample data from sample/layout.cnd...
                </textarea>
            </div>
        </div>
        
        <button onclick="testWithCustomData()">üöÄ Test with Custom Data</button>
        <button onclick="loadSampleData()">üìã Load Sample Data</button>
        <button onclick="clearCustomData()">üóëÔ∏è Clear</button>
    </div>

    <div class="container">
        <h3>ÔøΩüîç API Tests</h3>
        <p>Test the exported APIs and verify they work correctly:</p>
        
        <button onclick="testModuleImports()">Test Module Imports</button>
        <button onclick="testAlloyParsing()">Test Alloy XML Parsing</button>
        <button onclick="testLayoutSpec()">Test Layout Spec Parsing</button>
        <button onclick="testEvaluator()">Test Evaluator</button>
        <button onclick="testLayoutGeneration()">Test Full Layout Generation</button>
        <button onclick="testGenerateLayoutMethod()">Test LayoutInstance.generateLayout()</button>
        <button onclick="testWebColaTranslator()">Test WebCola Translator</button>
        <button onclick="testWebColaCnDGraph()">Test WebCola Custom Element</button>
        <button onclick="enableDebugMode()" style="background-color: #ff6b6b;">üîç Enable Debug Mode</button>
        
        <div id="output" class="output" style="display: none;"></div>
    </div>

    <div class="container">
        <h3>üìñ Sample Data</h3>
        <p>The demo automatically loads real sample data from the project:</p>
        
        <h4>Alloy Instance (from sample/datum.xml):</h4>
        <div class="code-sample">
Binary Search Tree Model with 5 Nodes
- Node0, Node1, Node2, Node3, Node4
- Relations: left, right, key
- Shows a connected tree structure
- Includes keys (integers) for each node
        </div>
        
        <h4>CND Layout Specification (from sample/layout.cnd):</h4>
        <div class="code-sample">
constraints:
  - orientation:
      selector: right
      directions: [right, below]
  - orientation:
      selector: left  
      directions: [left, below]
directives:
  - attribute:
      field: key
  - flag: hideDisconnectedBuiltIns
        </div>
        
        <p><em>This creates a proper binary tree layout with left children positioned left+below and right children positioned right+below, with node keys displayed as attributes.</em></p>
    </div>

    <script type="module">
        // Load sample data from actual files
        let sampleAlloyXML = '';
        let sampleCNDSpec = '';

        // Load sample files
        async function loadSampleFiles() {
            try {
                const [alloyResponse, cndResponse] = await Promise.all([
                    fetch('./sample/datum.xml'),
                    fetch('./sample/layout.cnd')
                ]);
                
                if (alloyResponse.ok && cndResponse.ok) {
                    sampleAlloyXML = await alloyResponse.text();
                    sampleCNDSpec = await cndResponse.text();
                } else {
                    // Fallback to hardcoded examples if files can't be loaded
                    console.warn('Could not load sample files, using fallback data');
                    sampleAlloyXML = `<alloy>
  <instance>
    <sig label="Person" ID="0">
      <atom label="Person$0"/>
      <atom label="Person$1"/>
    </sig>
    <sig label="Book" ID="1">
      <atom label="Book$0"/>
      <atom label="Book$1"/>
    </sig>
    <field label="owns" ID="2">
      <tuple>
        <atom label="Person$0"/>
        <atom label="Book$0"/>
      </tuple>
      <tuple>
        <atom label="Person$1"/>
        <atom label="Book$1"/>
      </tuple>
    </field>
  </instance>
</alloy>`;

                    sampleCNDSpec = `directives:
  hideDisconnected: false
  hideDisconnectedBuiltIns: true
  attributes: []
  hiddenFields: []
  projections: []

constraints:
  node:
    Person:
      shape: "rectangle"
      color: "#4CAF50"
      width: 100
      height: 60
    Book:
      shape: "rectangle" 
      color: "#2196F3"
      width: 80
      height: 50
  edge:
    owns:
      color: "#333333"
      style: "solid"
      width: 2`;
                }
            } catch (error) {
                console.error('Error loading sample files:', error);
                // Use fallback data on any error
            }
        }

        let cndCore = null;

        function showOutput(content, isError = false) {
            const output = document.getElementById('output');
            output.style.display = 'block';
            output.className = isError ? 'output error' : 'output success';
            output.textContent = content;
        }

        function getCurrentAlloyXML() {
            return document.getElementById('custom-alloy').value.trim() || sampleAlloyXML;
        }

        function getCurrentCNDSpec() {
            return document.getElementById('custom-cnd').value.trim() || sampleCNDSpec;
        }

        window.loadSampleData = function() {
            document.getElementById('custom-alloy').value = sampleAlloyXML;
            document.getElementById('custom-cnd').value = sampleCNDSpec;
            showOutput('‚úÖ Sample data loaded into input fields!');
        };

        window.clearCustomData = function() {
            document.getElementById('custom-alloy').value = '';
            document.getElementById('custom-cnd').value = '';
            showOutput('üóëÔ∏è Input fields cleared!');
        };

        window.testWithCustomData = async function() {
            try {
                const alloyXML = getCurrentAlloyXML();
                const cndSpec = getCurrentCNDSpec();
                
                if (!alloyXML || !cndSpec) {
                    throw new Error('Please provide both Alloy XML and CND specification');
                }
                
                showOutput('üîÑ Testing with your custom data...');
                
                if (!cndCore) {
                    await window.testModuleImports();
                }
                
                // Import required modules
                const alloyInstance = await import('./dist/alloy-instance.mjs');
                const layout = await import('./dist/layout.mjs');
                
                // Parse the custom data
                const datum = alloyInstance.parseAlloyXML(alloyXML);
                const instance = datum.instances[0];
                const layoutSpec = layout.parseLayoutSpec(cndSpec);
                
                // Create evaluator
                const evaluator = new cndCore.WrappedForgeEvaluator();
                
                // Try to initialize evaluator
                try {
                    await evaluator.initialize({
                        sourceData: alloyXML,
                        processedData: { instance },
                        sourceCode: '',
                        metadata: {}
                    });
                } catch (initError) {
                    console.warn('Evaluator initialization failed (expected):', initError.message);
                }
                
                // Test parsing results
                const result = `‚úÖ Successfully processed your custom data!

üìä Parsed Alloy Instance:
- Total instances: ${datum.instances.length}
- Types found: ${Object.keys(instance.types).join(', ')}
- Relations found: ${Object.keys(instance.relations).join(', ')}
- Total atoms: ${Object.values(instance.types).map(t => t.atoms.length).reduce((a, b) => a + b, 0)}

üé® Parsed CND Specification:
- Hide disconnected: ${layoutSpec.directives.hideDisconnected}
- Hide disconnected built-ins: ${layoutSpec.directives.hideDisconnectedBuiltIns}
- Attributes: ${layoutSpec.directives.attributes.length}
- Hidden fields: ${layoutSpec.directives.hiddenFields.length}
- Node constraints: ${Object.keys(layoutSpec.constraints.node || {}).length}
- Edge constraints: ${Object.keys(layoutSpec.constraints.edge || {}).length}

üöÄ Ready for Layout Generation:
All components created successfully and ready to generate layouts!

Atom Details:
${Object.entries(instance.types).map(([typeName, type]) => 
  `- ${typeName}: ${type.atoms.map(a => a.id).join(', ')}`
).join('\n')}

Relation Details:
${Object.entries(instance.relations).map(([relName, rel]) => 
  `- ${relName}: ${rel.tuples.length} tuples`
).join('\n')}`;
                
                showOutput(result);
                
            } catch (error) {
                showOutput(`‚ùå Custom Data Test Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        };

        window.testModuleImports = async function() {
            try {
                showOutput('Loading cnd-core modules...');
                
                // Import the main module
                cndCore = await import('./dist/index.mjs');
                
                const exports = Object.keys(cndCore);
                const result = `‚úÖ Module Import Test Successful!

Available exports:
${exports.map(exp => `- ${exp}`).join('\n')}

Key APIs:
- setupLayout: ${typeof cndCore.setupLayout}
- LayoutInstance: ${typeof cndCore.LayoutInstance}
- ForgeEvaluator: ${typeof cndCore.ForgeEvaluator}
- WrappedForgeEvaluator: ${typeof cndCore.WrappedForgeEvaluator}
- WebColaTranslator: ${typeof cndCore.WebColaTranslator}
- DagreTranslator: ${typeof cndCore.DagreTranslator}
- Translators: ${typeof cndCore.Translators}
- AlloyInstance: ${typeof cndCore.AlloyInstance}
- parseAlloyXML: ${typeof cndCore.parseAlloyXML || 'not available in main module'}

üîç DEBUG: Full cndCore object:
${JSON.stringify(Object.getOwnPropertyNames(cndCore), null, 2)}

Module loaded successfully!`;
                
                showOutput(result);
            } catch (error) {
                showOutput(`‚ùå Module Import Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        };

        window.testAlloyParsing = async function() {
            try {
                if (!cndCore) {
                    await window.testModuleImports();
                }
                
                showOutput('Testing Alloy XML parsing...');
                
                // Import alloy-instance module specifically
                const alloyInstance = await import('./dist/alloy-instance.mjs');
                
                const alloyXML = getCurrentAlloyXML();
                const datum = alloyInstance.parseAlloyXML(alloyXML);
                
                const result = `‚úÖ Alloy XML Parsing Test Successful!

Parsed Data Structure:
- Instances: ${datum.instances ? datum.instances.length : 'none'}
- Bitwidth: ${datum.bitwidth || 'not specified'}
- Command: ${datum.command || 'not specified'}

First Instance:
- Types: ${datum.instances[0] ? Object.keys(datum.instances[0].types).join(', ') : 'none'}
- Relations: ${datum.instances[0] ? Object.keys(datum.instances[0].relations).join(', ') : 'none'}

Type Details:
${Object.entries(datum.instances[0]?.types || {}).map(([typeName, type]) => 
  `- ${typeName}: ${type.atoms?.map(a => a.id).join(', ') || 'no atoms'}`
).join('\n')}

Relation Details:
${Object.entries(datum.instances[0]?.relations || {}).map(([relName, rel]) => 
  `- ${relName}: ${rel.tuples?.length || 0} tuples`
).join('\n')}`;
                
                showOutput(result);
            } catch (error) {
                showOutput(`‚ùå Alloy Parsing Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        };

        window.testLayoutSpec = async function() {
            try {
                if (!cndCore) {
                    await window.testModuleImports();
                }
                
                showOutput('Testing layout specification parsing...');
                
                // Import layout module specifically
                const layout = await import('./dist/layout.mjs');
                
                const cndYaml = getCurrentCNDSpec();
                const layoutSpec = layout.parseLayoutSpec(cndYaml);
                
                const result = `‚úÖ Layout Spec Parsing Successful!

=== COMPLETE CND LAYOUT SPECIFICATION ===
${JSON.stringify(layoutSpec, null, 2)}

=== ALL LAYOUT CONSTRAINTS (RAW) ===
${JSON.stringify(layoutSpec.constraints, null, 2)}`;
                
                showOutput(result);
            } catch (error) {
                showOutput(`‚ùå Layout Spec Parsing Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        }

        window.testLayoutGeneration = async function() {
            try {
                if (!cndCore) {
                    await window.testModuleImports();
                }
                
                showOutput('Testing full layout generation...');
                
                // Import required modules
                const alloyInstance = await import('./dist/alloy-instance.mjs');
                const layout = await import('./dist/layout.mjs');
                
                const xmlData = getCurrentAlloyXML();
                const cndYaml = getCurrentCNDSpec();
                
                const datum = alloyInstance.parseAlloyXML(xmlData);
                const instance = datum.instances[0];
                const layoutSpec = layout.parseLayoutSpec(cndYaml);
                
                // Create evaluator
                const evaluator = new cndCore.WrappedForgeEvaluator();
                
                // Create layout instance
                const layoutInstance = new cndCore.LayoutInstance(layoutSpec, evaluator);
                
                const result = `‚úÖ Layout Generation Test Completed!

=== ALLOY INSTANCE (COMPLETE) ===
${JSON.stringify(instance, null, 2)}

=== LAYOUT SPECIFICATION (COMPLETE) ===
${JSON.stringify(layoutSpec, null, 2)}

=== ALL LAYOUT CONSTRAINTS (RAW) ===
${JSON.stringify(layoutSpec.constraints, null, 2)}

=== LAYOUT INSTANCE OBJECT ===
Layout Instance Created: ${layoutInstance ? 'Yes' : 'No'}
Available Methods: ${Object.getOwnPropertyNames(Object.getPrototypeOf(layoutInstance)).filter(name => name !== 'constructor').join(', ')}`;
                
                showOutput(result);
            } catch (error) {
                showOutput(`‚ùå Layout Generation Test Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        }

        window.testEvaluator = async function() {
            try {
                if (!cndCore) {
                    await window.testModuleImports();
                }
                
                showOutput('Testing evaluator creation...');
                
                // Try different ways to access ForgeEvaluator
                let ForgeEvaluatorClass;
                if (cndCore.ForgeEvaluator) {
                    ForgeEvaluatorClass = cndCore.ForgeEvaluator;
                } else if (cndCore.Evaluators?.ForgeEvaluator) {
                    ForgeEvaluatorClass = cndCore.Evaluators.ForgeEvaluator;
                } else {
                    ForgeEvaluatorClass = cndCore.WrappedForgeEvaluator;
                }
                
                const evaluator = new ForgeEvaluatorClass();
                
                // Test basic evaluator interface
                const hasInitialize = typeof evaluator.initialize === 'function';
                const hasEvaluate = typeof evaluator.evaluate === 'function';
                const hasGetInstanceCount = typeof evaluator.getInstanceCount === 'function';
                
                const result = `‚úÖ Evaluator Test Successful!

Evaluator Interface Check:
- initialize() method: ${hasInitialize ? '‚úì' : '‚úó'}
- evaluate() method: ${hasEvaluate ? '‚úì' : '‚úó'}
- getInstanceCount() method: ${hasGetInstanceCount ? '‚úì' : '‚úó'}

Evaluator created successfully and implements IEvaluator interface!`;
                
                showOutput(result);
            } catch (error) {
                showOutput(`‚ùå Evaluator Test Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        };

        window.testLayoutGeneration = async function() {
            try {
                if (!cndCore) {
                    await window.testModuleImports();
                }
                
                showOutput('Testing full layout generation...');
                
                // Import required modules
                const alloyInstance = await import('./dist/alloy-instance.mjs');
                const layout = await import('./dist/layout.mjs');
                
                // Use current input data
                const alloyXML = getCurrentAlloyXML();
                const cndSpec = getCurrentCNDSpec();
                
                // Parse the Alloy XML using the correct pattern
                let ad;
                try {
                    ad = alloyInstance.parseAlloyXML(alloyXML);
                } catch (e) {
                    throw new Error("Error parsing Forge instance. Is it well formed? <br> <pre>" + e.message + "</pre>");
                }

                let command = ad.command || "";
                let instances = ad.instances;
                let loopBack = ad.loopBack || -1;
                
                // Get the first instance
                const instance = instances[0];
                const layoutSpec = layout.parseLayoutSpec(cndSpec);
                
                // Create ForgeEvaluator (not WrappedForgeEvaluator)
                let ForgeEvaluatorClass;
                if (cndCore.ForgeEvaluator) {
                    ForgeEvaluatorClass = cndCore.ForgeEvaluator;
                } else if (cndCore.Evaluators?.ForgeEvaluator) {
                    ForgeEvaluatorClass = cndCore.Evaluators.ForgeEvaluator;
                } else {
                    ForgeEvaluatorClass = cndCore.WrappedForgeEvaluator;
                }
                
                const evaluator = new ForgeEvaluatorClass();
                
                // Try to initialize evaluator (this might fail due to missing dependencies)
                try {
                    await evaluator.initialize({
                        sourceData: alloyXML,
                        processedData: { instance: instance },
                        sourceCode: '',
                        metadata: { 
                            command: command,
                            loopBack: loopBack,
                            alloyDatum: ad
                        }
                    });
                } catch (initError) {
                    // Expected to fail due to forge dependencies, continue anyway
                    console.warn('Evaluator initialization failed (expected):', initError.message);
                }
                
                // Create layout instance
                const layoutInstance = new cndCore.LayoutInstance(layoutSpec, evaluator);
                
                // Test the setupLayout convenience function
                let setupResult;
                try {
                    setupResult = cndCore.setupLayout(cndSpec, instance, evaluator);
                } catch (setupError) {
                    console.warn('setupLayout failed (expected due to evaluator):', setupError.message);
                }
                
                // Test LayoutInstance.generateLayout() method
                let generatedLayout;
                let layoutError = null;
                try {
                    // Call generateLayout with the instance and empty projections
                    const layoutResult = layoutInstance.generateLayout(instance, {});
                    generatedLayout = layoutResult.layout;
                } catch (generateError) {
                    layoutError = generateError;
                    console.warn('generateLayout failed:', generateError.message);
                }
                
                const result = `‚úÖ Layout Generation Test Completed!

=== ALLOY INSTANCE (COMPLETE) ===
${JSON.stringify(instance, null, 2)}

=== LAYOUT SPECIFICATION (COMPLETE) ===
${JSON.stringify(layoutSpec, null, 2)}

=== ALL LAYOUT CONSTRAINTS (RAW) ===
${JSON.stringify(layoutSpec.constraints, null, 2)}

=== LAYOUT INSTANCE OBJECT ===
Layout Instance Created: ${layoutInstance ? 'Yes' : 'No'}
Available Methods: ${Object.getOwnPropertyNames(Object.getPrototypeOf(layoutInstance)).filter(name => name !== 'constructor').join(', ')}

=== GENERATED LAYOUT RESULT ===
${generatedLayout ? `Layout Generated Successfully!

Layout Nodes (${generatedLayout.nodes?.length || 0}):
${JSON.stringify(generatedLayout.nodes, null, 2)}

Layout Edges (${generatedLayout.edges?.length || 0}):
${JSON.stringify(generatedLayout.edges, null, 2)}

Layout Constraints (${generatedLayout.constraints?.length || 0}):
${JSON.stringify(generatedLayout.constraints, null, 2)}

Layout Groups (${generatedLayout.groups?.length || 0}):
${JSON.stringify(generatedLayout.groups, null, 2)}

Complete Generated Layout Object:
${JSON.stringify(generatedLayout, null, 2)}` : `‚ùå Layout Generation Failed: ${layoutError?.message || 'Unknown error'}`}`;
                
                showOutput(result);
            } catch (error) {
                showOutput(`‚ùå Layout Generation Test Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        };

        window.testGenerateLayoutMethod = async function() {
            try {
                if (!cndCore) {
                    await window.testModuleImports();
                }
                
                showOutput('Testing LayoutInstance.generateLayout() method specifically...');
                
                // üîç DEBUG: Add breakpoint here - open DevTools and set breakpoint on next line
                console.log('üîç DEBUG: Starting generateLayout test');
                debugger; // This will break into the debugger when DevTools are open
                
                // Import required modules
                const alloyInstance = await import('./dist/alloy-instance.mjs');
                const layout = await import('./dist/layout.mjs');
                
                // Use current input data
                const alloyXML = getCurrentAlloyXML();
                const cndSpec = getCurrentCNDSpec();
                
                // Parse the Alloy XML using the correct pattern
                let ad;
                try {
                    ad = alloyInstance.parseAlloyXML(alloyXML);
                } catch (e) {
                    throw new Error("Error parsing Forge instance. Is it well formed? <br> <pre>" + e.message + "</pre>");
                }

                let command = ad.command || "";
                let instances = ad.instances;
                let loopBack = ad.loopBack || -1;
                
                // Get the first instance
                const instance = instances[0];
                const layoutSpec = layout.parseLayoutSpec(cndSpec);
                
                // üîç DEBUG: Log parsed data
                console.log('üîç DEBUG: Parsed AlloyDatum:', ad);
                console.log('üîç DEBUG: Command:', command);
                console.log('üîç DEBUG: Instances:', instances);
                console.log('üîç DEBUG: LoopBack:', loopBack);
                console.log('üîç DEBUG: First instance:', instance);
                console.log('üîç DEBUG: Parsed layout spec:', layoutSpec);
                
                // Create ForgeEvaluator (not WrappedForgeEvaluator) and pass in the parsed AlloyDatum
                console.log('üîç DEBUG: Available in cndCore:', Object.keys(cndCore));
                console.log('üîç DEBUG: cndCore.ForgeEvaluator:', cndCore.ForgeEvaluator);
                console.log('üîç DEBUG: cndCore.Evaluators:', cndCore.Evaluators);
                console.log('üîç DEBUG: cndCore.Evaluators.ForgeEvaluator:', cndCore.Evaluators?.ForgeEvaluator);
                
                // Try different ways to access ForgeEvaluator
                let ForgeEvaluatorClass;
                if (cndCore.ForgeEvaluator) {
                    ForgeEvaluatorClass = cndCore.ForgeEvaluator;
                    console.log('üîç DEBUG: Using cndCore.ForgeEvaluator');
                } else if (cndCore.Evaluators?.ForgeEvaluator) {
                    ForgeEvaluatorClass = cndCore.Evaluators.ForgeEvaluator;
                    console.log('üîç DEBUG: Using cndCore.Evaluators.ForgeEvaluator');
                } else {
                    // Fallback to WrappedForgeEvaluator
                    ForgeEvaluatorClass = cndCore.WrappedForgeEvaluator;
                    console.log('üîç DEBUG: Falling back to cndCore.WrappedForgeEvaluator');
                }
                
                const evaluator = new ForgeEvaluatorClass();
                
                // üîç DEBUG: Check evaluator state
                console.log('üîç DEBUG: Evaluator created:', evaluator);
                console.log('üîç DEBUG: Evaluator methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(evaluator)));
                
                // Try to initialize the evaluator properly
                try {
                    console.log('üîç DEBUG: Attempting evaluator initialization...');
                    await evaluator.initialize({
                        sourceData: alloyXML,
                        processedData: { instance: instance },
                        sourceCode: '',
                        metadata: { 
                            command: command,
                            loopBack: loopBack,
                            alloyDatum: ad
                        }
                    });
                    console.log('üîç DEBUG: Evaluator initialized successfully');
                } catch (initError) {
                    console.error('üîç DEBUG: Evaluator initialization failed:', initError);
                    console.error('üîç DEBUG: Error details:', {
                        message: initError.message,
                        stack: initError.stack,
                        evaluatorReady: evaluator.isReady()
                    });
                    // Don't throw here, continue to see what happens
                }
                
                // Create layout instance
                const layoutInstance = new cndCore.LayoutInstance(layoutSpec, evaluator);
                
                // üîç DEBUG: Check layout instance
                console.log('üîç DEBUG: LayoutInstance created:', layoutInstance);
                console.log('üîç DEBUG: LayoutInstance methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(layoutInstance)));
                
                // Call generateLayout method with different projection scenarios
                let layoutResults = [];
                let errors = [];
                
                // Test 1: Empty projections
                try {
                    console.log('üîç DEBUG: Calling generateLayout with empty projections...');
                    debugger; // Break here before the generateLayout call
                    const result1 = layoutInstance.generateLayout(instance, {});
                    console.log('üîç DEBUG: generateLayout succeeded:', result1);
                    
                    // Store the layout globally for the custom element to use
                    window.lastInstanceLayout = result1.layout;
                    
                    layoutResults.push({ 
                        scenario: 'Empty Projections', 
                        result: result1.layout,
                        projectionData: result1.projectionData 
                    });
                } catch (error) {
                    console.error('üîç DEBUG: generateLayout failed:', error);
                    console.error('üîç DEBUG: Error stack:', error.stack);
                    errors.push({ scenario: 'Empty Projections', error: error.message, fullError: error });
                }
                
                // Test 2: With sample projections (if any projection fields exist)
                const instanceTypes = Object.keys(instance.types || {});
                if (instanceTypes.length > 0) {
                    try {
                        const sampleProjections = {}; // Could be enhanced with actual projection logic
                        const result2 = layoutInstance.generateLayout(instance, sampleProjections);
                        
                        // Update the global layout if this succeeds
                        window.lastInstanceLayout = result2.layout;
                        
                        layoutResults.push({ 
                            scenario: 'Sample Projections', 
                            result: result2.layout,
                            projectionData: result2.projectionData 
                        });
                    } catch (error) {
                        errors.push({ scenario: 'Sample Projections', error: error.message });
                    }
                }
                
                const result = `‚úÖ LayoutInstance.generateLayout() Test Results!

=== METHOD CALL RESULTS ===
${layoutResults.length > 0 ? layoutResults.map((lr, i) => `
--- Scenario ${i + 1}: ${lr.scenario} ---
Generated Layout Nodes (${lr.result.nodes?.length || 0}):
${JSON.stringify(lr.result.nodes, null, 2)}

Generated Layout Edges (${lr.result.edges?.length || 0}):
${JSON.stringify(lr.result.edges, null, 2)}

Generated Layout Constraints (${lr.result.constraints?.length || 0}):
${JSON.stringify(lr.result.constraints, null, 2)}

Generated Layout Groups (${lr.result.groups?.length || 0}):
${JSON.stringify(lr.result.groups, null, 2)}

Projection Data:
${JSON.stringify(lr.projectionData, null, 2)}

Complete Generated Layout:
${JSON.stringify(lr.result, null, 2)}
`).join('\n') : 'No successful layout generation'}

=== ERRORS ENCOUNTERED ===
${errors.length > 0 ? errors.map(e => `- ${e.scenario}: ${e.error}`).join('\n') : 'No errors'}

=== LAYOUT INSTANCE DETAILS ===
Instance Created: ${layoutInstance ? 'Yes' : 'No'}
Layout Spec: ${JSON.stringify(layoutSpec, null, 2)}`;
                
                showOutput(result);
            } catch (error) {
                showOutput(`‚ùå LayoutInstance.generateLayout() Test Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        };

        window.testWebColaTranslator = async function() {
            try {
                if (!cndCore) {
                    await window.testModuleImports();
                }
                
                showOutput('Testing WebCola Translator...');
                
                // Import required modules
                const alloyInstance = await import('./dist/alloy-instance.mjs');
                const layout = await import('./dist/layout.mjs');
                const translators = await import('./dist/translators.mjs');
                
                // Parse the data
                const alloyXML = getCurrentAlloyXML();
                const cndSpec = getCurrentCNDSpec();
                
                let ad;
                try {
                    ad = alloyInstance.parseAlloyXML(alloyXML);
                } catch (e) {
                    throw new Error("Error parsing Forge instance. Is it well formed? <br> <pre>" + e.message + "</pre>");
                }

                const instance = ad.instances[0];
                const layoutSpec = layout.parseLayoutSpec(cndSpec);
                
                // Create evaluator and layout instance
                let ForgeEvaluatorClass;
                if (cndCore.ForgeEvaluator) {
                    ForgeEvaluatorClass = cndCore.ForgeEvaluator;
                } else if (cndCore.Evaluators?.ForgeEvaluator) {
                    ForgeEvaluatorClass = cndCore.Evaluators.ForgeEvaluator;
                } else {
                    ForgeEvaluatorClass = cndCore.WrappedForgeEvaluator;
                }
                
                const evaluator = new ForgeEvaluatorClass();
                
                // Try to initialize evaluator (might fail, continue anyway)
                try {
                    await evaluator.initialize({
                        sourceData: alloyXML,
                        processedData: { instance: instance },
                        sourceCode: '',
                        metadata: { 
                            command: ad.command || "",
                            loopBack: ad.loopBack || -1,
                            alloyDatum: ad
                        }
                    });
                } catch (initError) {
                    console.warn('Evaluator initialization failed (expected):', initError.message);
                }
                
                const layoutInstance = new cndCore.LayoutInstance(layoutSpec, evaluator);
                
                // Generate layout
                let generatedLayout;
                try {
                    const layoutResult = layoutInstance.generateLayout(instance, {});
                    generatedLayout = layoutResult.layout;
                } catch (generateError) {
                    console.warn('generateLayout failed:', generateError.message);
                    // Create a minimal layout for testing the translator
                    generatedLayout = {
                        nodes: [
                            { id: 'Node0', x: 100, y: 100, width: 80, height: 50, color: '#4CAF50', mostSpecificType: 'Node', showLabels: true },
                            { id: 'Node1', x: 200, y: 150, width: 80, height: 50, color: '#4CAF50', mostSpecificType: 'Node', showLabels: true }
                        ],
                        edges: [
                            { id: 'edge1', source: { id: 'Node0' }, target: { id: 'Node1' }, relationName: 'right', label: 'right' }
                        ],
                        constraints: [],
                        groups: []
                    };
                }
                
                console.log('üîß Testing WebCola Translator with layout:', generatedLayout);
                
                // Test WebColaTranslator - use the correct API
                let webColaTranslator;
                let webColaLayout;
                
                if (cndCore.WebColaTranslator) {
                    webColaTranslator = new cndCore.WebColaTranslator();
                    webColaLayout = await webColaTranslator.translate(generatedLayout);
                } else if (cndCore.Translators?.WebColaTranslator) {
                    webColaTranslator = new cndCore.Translators.WebColaTranslator();
                    webColaLayout = await webColaTranslator.translate(generatedLayout);
                } else if (translators.WebColaTranslator) {
                    webColaTranslator = new translators.WebColaTranslator();
                    webColaLayout = await webColaTranslator.translate(generatedLayout);
                } else {
                    throw new Error('WebColaTranslator not found in any expected location');
                }
                
                console.log('üîß WebColaTranslator created:', webColaTranslator);
                console.log('üîß WebColaLayout result:', webColaLayout);
                
                const result = `‚úÖ WebCola Translator Test Successful!

=== WEBCOLA TRANSLATION RESULT ===
Translator Created: ${webColaTranslator ? 'Yes' : 'No'}
Layout Translated: ${webColaLayout ? 'Yes' : 'No'}

WebCola Nodes (${webColaLayout?.nodes?.length || 0}):
${JSON.stringify(webColaLayout?.nodes, null, 2)}

WebCola Links (${webColaLayout?.links?.length || 0}):
${JSON.stringify(webColaLayout?.links, null, 2)}

WebCola Constraints (${webColaLayout?.constraints?.length || 0}):
${JSON.stringify(webColaLayout?.constraints, null, 2)}

WebCola Groups (${webColaLayout?.groups?.length || 0}):
${JSON.stringify(webColaLayout?.groups, null, 2)}

Layout Dimensions: ${webColaLayout?.FIG_WIDTH || 0} x ${webColaLayout?.FIG_HEIGHT || 0}

‚úÖ WebColaTranslator successfully converted the layout data to WebCola format!`;
                
                showOutput(result);
            } catch (error) {
                showOutput(`‚ùå WebCola Translator Test Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        };

        window.testWebColaCnDGraph = async function() {
            try {
                if (!cndCore) {
                    await window.testModuleImports();
                }
                
                showOutput('Testing WebCola Custom Element...');
                
                // Import the custom element
                const translators = await import('./dist/translators.mjs');
                
                console.log('Available in translators module:', Object.keys(translators));
                
                // Import WebColaCnDGraph directly
                let WebColaCnDGraphClass;
                try {
                    console.log('üîç Available in translators module:', Object.keys(translators));
                    console.log('üîç WebColaCnDGraph type:', typeof translators.WebColaCnDGraph);
                    console.log('üîç WebColaCnDGraph value:', translators.WebColaCnDGraph);
                    
                    // The WebColaCnDGraph should be available in the translators module
                    if (translators.WebColaCnDGraph) {
                        WebColaCnDGraphClass = translators.WebColaCnDGraph;
                        console.log('‚úÖ WebColaCnDGraph imported from translators module');
                    } else {
                        console.error('‚ùå WebColaCnDGraph not found. Available exports:', Object.keys(translators));
                        throw new Error('WebColaCnDGraph not found in translators module');
                    }
                } catch (error) {
                    console.error('Error importing WebColaCnDGraph:', error);
                    throw new Error('Could not load WebColaCnDGraph: ' + error.message);
                }
                
                console.log('üîß WebColaCnDGraph class found:', WebColaCnDGraphClass);
                
                // Get current data
                const alloyXML = getCurrentAlloyXML();
                const cndSpec = getCurrentCNDSpec();
                
                // Create and add the custom element to the page
                const container = document.createElement('div');
                container.style.cssText = `
                    margin: 20px 0;
                    padding: 20px;
                    border: 2px solid #007acc;
                    border-radius: 8px;
                    background: #f8f9fa;
                `;
                
                const title = document.createElement('h4');
                title.textContent = 'üéØ WebCola Custom Element Live Demo';
                title.style.margin = '0 0 15px 0';
                container.appendChild(title);
                
                const webColaGraph = document.createElement('webcola-cnd-graph');
                webColaGraph.setAttribute('width', '800');
                webColaGraph.setAttribute('height', '400');
                webColaGraph.style.cssText = `
                    display: block;
                    width: 100%;
                    height: 400px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                `;
                
                container.appendChild(webColaGraph);
                
                // Add some controls
                const controls = document.createElement('div');
                controls.style.marginTop = '10px';
                
                const renderButton = document.createElement('button');
                renderButton.textContent = 'Render Layout';
                renderButton.onclick = async () => {
                    try {
                        // We need to get the InstanceLayout that was created earlier
                        if (window.lastInstanceLayout) {
                            await webColaGraph.renderLayout(window.lastInstanceLayout);
                        } else {
                            alert('No layout available. Please run "Generate Layout Instance" first.');
                        }
                    } catch (error) {
                        console.error('Error rendering layout:', error);
                        alert('Error rendering layout: ' + error.message);
                    }
                };
                
                const clearButton = document.createElement('button');
                clearButton.textContent = 'Clear';
                clearButton.onclick = () => webColaGraph.clear();
                
                controls.appendChild(renderButton);
                controls.appendChild(clearButton);
                container.appendChild(controls);
                
                // Insert the container after the output div
                const outputDiv = document.getElementById('output');
                if (outputDiv) {
                    outputDiv.parentNode.insertBefore(container, outputDiv.nextSibling);
                }
                
                const result = `‚úÖ WebCola Custom Element Test Successful!

=== CUSTOM ELEMENT DETAILS ===
Element Tag: <webcola-cnd-graph>
Class Available: ${WebColaCnDGraphClass ? 'Yes' : 'No'}
Custom Element Registered: ${customElements.get('webcola-cnd-graph') ? 'Yes' : 'No'}

Attributes Set:
- width: 800
- height: 400
- alloy-xml: ${alloyXML.length} characters
- layout-spec: ${cndSpec.length} characters

üéØ Live visualization should appear above this message!

Features:
‚úì Shadow DOM encapsulation
‚úì Attribute-based configuration
‚úì Automatic rendering on data change
‚úì Error handling and loading states
‚úì SVG-based visualization with proper CSS
‚úì WebCola integration for layout

You can:
‚Ä¢ Refresh the visualization with new data
‚Ä¢ Clear the current visualization
‚Ä¢ Inspect the element in DevTools`;
                
                showOutput(result);
            } catch (error) {
                showOutput(`‚ùå WebCola Custom Element Test Failed:\n${error.message}\n\nStack:\n${error.stack}`, true);
            }
        };

        window.enableDebugMode = function() {
            showOutput(`üîç DEBUG MODE ENABLED

To debug the generateLayout method:

1. Open Browser Developer Tools (F12 or Ctrl+Shift+I / Cmd+Option+I)
2. Go to the 'Sources' or 'Debugger' tab
3. Click 'Test LayoutInstance.generateLayout()' button
4. The debugger will automatically break at key points

DEBUG BREAKPOINTS ADDED:
‚úì Before generateLayout test starts
‚úì Before generateLayout() method call
‚úì Enhanced console logging for all steps
‚úì Full error stack traces

CONSOLE LOGS TO WATCH:
üîç DEBUG: Starting generateLayout test
üîç DEBUG: Parsed Alloy instance
üîç DEBUG: Parsed layout spec  
üîç DEBUG: Evaluator created
üîç DEBUG: Evaluator initialization
üîç DEBUG: LayoutInstance created
üîç DEBUG: Calling generateLayout
üîç DEBUG: generateLayout result/error

TIP: In the Console tab, you can inspect variables:
- instance (the parsed Alloy data)
- layoutSpec (the parsed CND spec)
- evaluator (the evaluator object)
- layoutInstance (the layout instance)
- result1 (the generateLayout result)

Press F10 to step over, F11 to step into, F8 to continue.`);
        };

        // Auto-run module import test on load and load sample files
        window.addEventListener('load', async () => {
            // Load sample files first
            await loadSampleFiles();
            
            // Populate text areas with loaded sample data
            document.getElementById('custom-alloy').value = sampleAlloyXML;
            document.getElementById('custom-cnd').value = sampleCNDSpec;
            
            // Then test module imports
            setTimeout(() => {
                window.testModuleImports();
            }, 500);
        });
    </script>
</body>
</html>
