<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCola CND Unified Demo</title>
    <style>
        /* ...existing styles... */
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ WebCola Visualization Demo (Alloy & DOT)</h1>
        <p>This demonstrates Alloy XML or DOT â†’ DataInstance â†’ Evaluator â†’ Layout â†’ WebCola pipeline.</p>
        
        <!-- Language Selector -->
        <label for="inputLanguage">Input Language:</label>
        <select id="inputLanguage" onchange="onInputLanguageChange()">
            <option value="alloy" selected>Alloy XML</option>
            <option value="dot">DOT</option>
        </select>
        
        <!-- Editable Input Fields -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label id="inputLabel" for="inputArea">Alloy XML Instance:</label>
                <textarea id="inputArea" placeholder="Paste your Alloy XML instance here..."></textarea>
            </div>
            <div>
                <label for="webcola-cnd">CND Layout Specification (YAML):</label>
                <textarea id="webcola-cnd" placeholder="Paste your CND layout specification here..."></textarea>
            </div>
        </div>
        
        <div>
            <button onclick="loadGraph()">Load & Render Graph</button>
            <button onclick="loadData()">Load Data Only</button>
            <button onclick="renderGraph()">Render Graph</button>
            <button onclick="clearGraph()">Clear Graph</button>
            <select title="Choose the Layout Format" class="form-control" id="layoutFormat" name="layoutFormat" onchange="changeLayoutFormat()">
                <option value="default" selected>Standard</option>
                <option value="grid">Grid (Beta)</option>
            </select>
        </div>
        
        <!-- Use the webcola-cnd-graph custom element -->
        <webcola-cnd-graph 
            id="graph-container"
            width="800" 
            height="600"
            layoutFormat="default">
        </webcola-cnd-graph>
        
        <div id="status" class="status info">Ready to load graph...</div>
    </div>

    <!-- D3 v4 and WebCola -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="./vendor/cola.js"></script>
    <!-- CND-Core browser bundle -->
    <script src="./dist/browser/cnd-core-complete.global.js"></script>
    <script>
        // --- State ---
        let currentInstanceLayout = null;
        let currentDataInstance = null;
        let currentEvaluator = null;

        // --- UI Helpers ---
        function getInputLanguage() {
            return document.getElementById('inputLanguage').value;
        }
        function getInputText() {
            return document.getElementById('inputArea').value.trim();
        }
        function getCurrentCNDSpec() {
            return document.getElementById('webcola-cnd').value.trim();
        }
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        // --- UI Language Switch ---
        function onInputLanguageChange() {
            const lang = getInputLanguage();
            const inputLabel = document.getElementById('inputLabel');
            const inputArea = document.getElementById('inputArea');
            if (lang === 'alloy') {
                inputLabel.textContent = "Alloy XML Instance:";
                inputArea.placeholder = "Paste your Alloy XML instance here...";
            } else {
                inputLabel.textContent = "DOT Graph Specification:";
                inputArea.placeholder = "Paste your DOT graph here...";
            }
            // Optionally clear previous state
            currentInstanceLayout = null;
            currentDataInstance = null;
            currentEvaluator = null;
            updateStatus('Switched input language. Ready to load new data.', 'info');
        }

        // --- Pipeline Logic ---
        async function loadData() {
            const lang = getInputLanguage();
            updateStatus(`Processing ${lang.toUpperCase()} data...`, 'info');
            try {
                const input = getInputText();
                if (!input) throw new Error(`Please enter a ${lang.toUpperCase()} instance`);
                const cndSpec = getCurrentCNDSpec() || "";

                if (lang === 'alloy') {
                    // Alloy pipeline
                    const alloyDatum = CndCore.AlloyInstance.parseAlloyXML(input);
                    if (!alloyDatum.instances || alloyDatum.instances.length === 0) {
                        throw new Error('No instances found in Alloy XML');
                    }
                    currentDataInstance = new CndCore.AlloyDataInstance(alloyDatum.instances[0]);
                    currentEvaluator = new CndCore.ForgeEvaluator();
                    currentEvaluator.initialize({ sourceData: input });
                } else {
                    // DOT pipeline
                    currentDataInstance = CndCore.createDotDataInstance(input);
                    currentEvaluator = new CndCore.SimpleGraphQueryEvaluator();
                    currentEvaluator.initialize({ dataInstance: currentDataInstance });
                }

                // Parse layout spec
                const layoutSpec = CndCore.parseLayoutSpec(cndSpec);
                const instanceNumber = 0;
                const ENABLE_ALIGNMENT_EDGES = true;
                const layoutInstance = new CndCore.LayoutInstance(
                    layoutSpec,
                    currentEvaluator,
                    instanceNumber,
                    ENABLE_ALIGNMENT_EDGES
                );
                // Generate layout
                const projections = {};
                const layoutResult = layoutInstance.generateLayout(currentDataInstance, projections);
                currentInstanceLayout = layoutResult.layout;

                updateStatus(`${lang.toUpperCase()} pipeline complete! Ready to render.`, 'success');
            } catch (error) {
                console.error(`Failed to load ${getInputLanguage()} data:`, error);
                updateStatus(`${getInputLanguage().toUpperCase()} data loading failed: ${error.message}`, 'error');
            }
        }

        async function renderGraph() {
            const graphElement = document.getElementById('graph-container');
            try {
                if (!currentInstanceLayout) {
                    updateStatus('No layout data available. Processing data first...', 'info');
                    await loadData();
                    if (!currentInstanceLayout) {
                        throw new Error('Failed to generate layout data');
                    }
                }
                updateStatus('Rendering graph with WebCola...', 'info');
                await graphElement.renderLayout(currentInstanceLayout);
                updateStatus('Graph rendered successfully!', 'success');
            } catch (error) {
                console.error('Error rendering graph:', error);
                updateStatus(`Render error: ${error.message}`, 'error');
            }
        }

        function clearGraph() {
            const graphElement = document.getElementById('graph-container');
            if (graphElement.clear) {
                graphElement.clear();
            } else {
                const svg = graphElement.shadowRoot?.querySelector('svg');
                if (svg) {
                    const container = svg.querySelector('.zoomable');
                    if (container) container.innerHTML = '';
                }
            }
            currentInstanceLayout = null;
            currentDataInstance = null;
            currentEvaluator = null;
            updateStatus('Graph cleared.', 'info');
        }

        async function loadGraph() {
            try {
                await loadData();
                await renderGraph();
            } catch (error) {
                console.error('Failed to load and render graph:', error);
                updateStatus(`Failed to load graph: ${error.message}`, 'error');
            }
        }

        async function changeLayoutFormat() {
            const graphElement = document.getElementById('graph-container');
            const layoutFormat = document.getElementById('layoutFormat').value;
            graphElement.setAttribute('layoutFormat', layoutFormat);
            console.log(`Layout format changed to: ${layoutFormat}`);
            try {
                await graphElement.renderLayout(currentInstanceLayout);
                updateStatus('Graph re-rendered with new layout format!', 'success');
            } catch (error) {
                console.error('Error rendering graph:', error);
                updateStatus(`Render error: ${error.message}`, 'error');
            }
        }

        // Auto-initialize when page loads
        window.addEventListener('load', () => {
            onInputLanguageChange();
            updateStatus('Ready to load graph...', 'info');
        });

        // Expose functions globally for buttons
        window.loadGraph = loadGraph;
        window.loadData = loadData;
        window.renderGraph = renderGraph;
        window.clearGraph = clearGraph;
        window.onInputLanguageChange = onInputLanguageChange;
        window.changeLayoutFormat = changeLayoutFormat;
    </script>
</body>
</html>