<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DOT → Alloy → WebCola Demo</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    #graph { border: 1px solid #ccc; width: 800px; height: 500px; }
    textarea { width: 800px; height: 120px; }
    button { margin: 1em 0; }
    svg { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <h2>DOT → Alloy → WebCola Demo</h2>
  <textarea id="dotInput">// Enter DOT here
digraph {
  A [type=Entity];
  B [type=Entity];
  C [type=Relation];
  A -> B [label="connects"];
  B -> C [label="belongs_to"];
}
</textarea>
  <br>
  <button id="runBtn">Run DOT Evaluator & Layout</button>
  <div id="graph"></div>
  <pre id="output"></pre>

  <!-- Load webcola and your bundle (adjust paths as needed) -->
  <script src="vendor/cola.js"></script>
  <script src="dist/browser/cnd-core-complete.global.js"></script>
  <script>
    // DotEvaluator is now available via the global CndCore object
    const { DotEvaluator } = window.CndCore;

    // Minimal SVG rendering for demo
    function renderGraph(nodes, links) {
      const svgNS = "http://www.w3.org/2000/svg";
      const width = 800, height = 500;
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", width);
      svg.setAttribute("height", height);

      // Draw links
      for (const l of links) {
        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("x1", l.source.x);
        line.setAttribute("y1", l.source.y);
        line.setAttribute("x2", l.target.x);
        line.setAttribute("y2", l.target.y);
        line.setAttribute("stroke", "#888");
        line.setAttribute("stroke-width", "2");
        svg.appendChild(line);
      }
      // Draw nodes
      for (const n of nodes) {
        const circle = document.createElementNS(svgNS, "circle");
        circle.setAttribute("cx", n.x);
        circle.setAttribute("cy", n.y);
        circle.setAttribute("r", 20);
        circle.setAttribute("fill", "#4a90e2");
        svg.appendChild(circle);

        const text = document.createElementNS(svgNS, "text");
        text.setAttribute("x", n.x);
        text.setAttribute("y", n.y + 5);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#fff");
        text.setAttribute("font-size", "16");
        text.textContent = n.id;
        svg.appendChild(text);
      }
      return svg;
    }

    document.getElementById('runBtn').onclick = async () => {
      const dot = document.getElementById('dotInput').value;
      const output = document.getElementById('output');
      const graphDiv = document.getElementById('graph');
      output.textContent = '';

      try {
        // 1. Evaluate DOT using DotEvaluator
        const evaluator = new DotEvaluator();
        evaluator.initialize({ sourceData: dot });
        // For demo, just get all atoms and relations
        const atoms = evaluator.forgeEvaluator['instance']?.getAtoms?.() || [];
        const relations = evaluator.forgeEvaluator['instance']?.getRelations?.() || [];

        // 2. Build nodes/links for webcola
        const nodes = atoms.map(a => ({ id: a.id }));
        const links = [];
        for (const rel of relations) {
          if (rel.tuples) {
            for (const t of rel.tuples) {
              if (t.atoms.length === 2) {
                links.push({ source: t.atoms[0], target: t.atoms[1] });
              }
            }
          }
        }

        // 3. Layout with webcola
        const cola = window.cola.d3adaptor()
          .size([800, 500])
          .nodes(nodes)
          .links(links)
          .jaccardLinkLengths(120)
          .avoidOverlaps(true)
          .start(30, 0, 20);

        cola.on('end', () => {
          graphDiv.innerHTML = '';
          graphDiv.appendChild(renderGraph(nodes, links));
        });

        output.textContent = 'Nodes: ' + JSON.stringify(nodes, null, 2) +
          '\nLinks: ' + JSON.stringify(links, null, 2);

      } catch (err) {
        output.textContent = 'Error: ' + (err && err.message ? err.message : err);
      }
    };
  </script>
</body>
</html>
